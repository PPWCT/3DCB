<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://accounts.google.com https://apis.google.com; connect-src 'self' https://www.googleapis.com https://accounts.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:;">
    <!-- PRODUCTION NOTE: For enhanced security, move inline scripts/styles to external files and use nonces/hashes instead of 'unsafe-inline' -->
    <title>3-Day Call Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Fixed: onload handlers eliminate race conditions -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <script>
        const CLIENT_ID = '31947493557-aqbcb8n3fag89rcjnchj5p6gufuh1oda.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const CALL_BOARD_FILENAME = '3day-call-board-data.txt';
        const DRIVE_FOLDER_ID = '1OFC7Zw08MgaVfnRCO3TPX17lnehVpXNU';
        
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
    </script>
    <style>
        :root {
            --primary-red:    #ef4444;       /* totals / alerts */
            --light-bg:       #1a0505;       /* dark crimson tinted bg */
            --text-color:     #f5f0f0;       /* near-white text */
            --border-color:   #3d1515;       /* crimson-tinted border */
            --success-green:  #86efac;       /* goal met */
            --warning-yellow: #fcd34d;       /* goal close */
            --tech-blue:      #8ebeef;       /* PPW light blue accent */
            --cancel-red:     #770a0a;       /* cancelled */
            --dark-bg:        #0d0202;       /* deepest background */
            --soft-text:      #c9b8b8;       /* muted text */
            --glow-blue:      rgba(142, 190, 239, 0.12);
            --ppw-crimson:    #770a0a;       /* brand crimson */
            --ppw-blue:       #8ebeef;       /* brand blue */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: #0d0202;
            padding: 0;
            min-height: 100vh;
            color: var(--text-color);
            position: relative;
            margin: 0;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 25% 35%, rgba(119, 10, 10, 0.18) 0%, transparent 45%),
                radial-gradient(circle at 75% 65%, rgba(142, 190, 239, 0.08) 0%, transparent 45%);
            animation: gentleBreath 14s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes gentleBreath {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50%       { opacity: 0.9; transform: scale(1.03); }
        }
        
        /* Focus styles */
        *:focus-visible {
            outline: 3px solid var(--ppw-blue);
            outline-offset: 2px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 0;
            position: relative;
            padding: 16px 24px 12px 24px;
            background: rgba(13, 2, 2, 0.95);
            border-bottom: 2px solid var(--ppw-crimson);
        }
        
        .auth-corner {
            position: absolute;
            top: 12px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .auth-corner-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            background: rgba(119, 10, 10, 0.25);
            color: var(--ppw-blue);
            border: 1px solid var(--ppw-crimson);
        }
        
        .auth-corner-btn:hover {
            background: rgba(119, 10, 10, 0.45);
            transform: translateY(-1px);
        }
        
        .auth-corner-btn.signout {
            background: rgba(119, 10, 10, 0.2);
            color: #f87171;
            border-color: #770a0a;
        }
        
        .auth-corner-btn.signout:hover {
            background: rgba(119, 10, 10, 0.4);
        }
        
        .auth-status {
            font-size: 11px;
            color: var(--success-green);
        }
        
        .title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: #ffffff;
            letter-spacing: 6px;
            margin-bottom: 0;
            text-shadow: 0 0 28px rgba(119, 10, 10, 0.7);
        }
        
        .subtitle {
            font-size: 14px;
            color: var(--text-color);
            font-weight: 600;
            opacity: 0.9;
        }
        
        .date-picker-section {
            background: rgba(26, 5, 5, 0.7);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border: none;
            border-bottom: 1px solid rgba(119, 10, 10, 0.5);
        }
        
        .date-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: linear-gradient(135deg, #770a0a 0%, #a01010 100%);
            color: #ffffff;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .date-nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(119, 10, 10, 0.5);
        }
        
        .date-nav-btn:active {
            transform: translateY(0);
        }
        
        .date-picker-label {
            font-weight: 700;
            color: var(--text-color);
        }
        
        .date-picker-input {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            background: rgba(20, 3, 3, 0.7);
            cursor: pointer;
        }
        
        .apply-dates-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, #770a0a 0%, #a01010 100%);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .apply-dates-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(119, 10, 10, 0.5);
        }
        
        .apply-dates-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .date-preview {
            font-size: 14px;
            color: var(--soft-text);
        }
        
        .google-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .google-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .google-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .google-btn.signin {
            background: #4285f4;
            color: white;
        }
        
        .google-btn.save {
            background: linear-gradient(135deg, var(--success-green) 0%, #22c55e 100%);
            color: #1f2937;
        }
        
        .google-btn.load {
            background: linear-gradient(135deg, #770a0a 0%, #a01010 100%);
            color: #ffffff;
        }
        
        .google-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .sync-status {
            text-align: center;
            font-size: 10px;
            color: var(--soft-text);
            margin: 0;
            padding: 4px 0;
            min-height: 16px;
            background: rgba(13, 2, 2, 0.8);
        }
        
        .sync-status.success { color: var(--success-green); }
        .sync-status.error { color: #ef4444; }
        
        .board {
            background: rgba(20, 3, 3, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            border: none;
        }
        
        .board-scroll-wrapper {
            overflow-x: auto;
        }
        
        .goals-bar {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: linear-gradient(135deg, rgba(119, 10, 10, 0.4) 0%, rgba(119, 10, 10, 0.2) 100%);
            padding: 10px;
            gap: 10px;
            min-width: 600px;
            border-bottom: 1px solid rgba(119, 10, 10, 0.4);
        }
        
        .goal-item {
            text-align: center;
        }
        
        .goal-item.empty {
            background: transparent;
        }
        
        .goal-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 4px;
        }
        
        .goal-value {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .goal-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: #F0F2F5;
        }
        
        .goal-arrows {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .arrow-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            transition: all 0.2s;
            user-select: none;
        }
        
        .arrow-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.15);
        }
        
        .arrow-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .arrow-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
        
        .grid-container {
            min-width: 600px;
        }
        
        .grid-header {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(50, 5, 5, 0.8);
            color: var(--text-color);
            font-weight: 700;
            text-align: center;
            padding: 10px 8px;
            border-bottom: 2px solid var(--ppw-crimson);
            font-size: 13px;
        }
        
        .grid-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            border-bottom: 1px solid var(--border-color);
            min-height: 70px;
        }
        
        .grid-row:hover {
            background: rgba(42, 46, 61, 0.3);
        }
        
        .tech-name {
            padding: 12px 16px;
            font-weight: 700;
            color: var(--ppw-blue);
            display: flex;
            align-items: center;
            border-right: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        .day-cell {
            padding: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--border-color);
            position: relative;
        }
        
        .add-job-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px dashed var(--ppw-crimson);
            background: rgba(119, 10, 10, 0.1);
            color: var(--ppw-blue);
            font-weight: bold;
        }
        
        .add-job-btn:hover {
            transform: scale(1.1);
            background: rgba(119, 10, 10, 0.2);
            border-style: solid;
        }
        
        /* Priority 3: Larger, clearer markers */
        .appt-marker {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px dashed var(--border-color);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .appt-marker.empty {
            border: 2px dashed rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.02);
        }
        
        .appt-marker.empty::before {
            content: '‚¨ö';
            color: rgba(255, 255, 255, 0.2);
            font-size: 1.5rem;
        }
        
        .appt-marker:hover {
            transform: scale(1.1);
            border-style: solid;
        }
        
        .appt-marker.filled {
            background: linear-gradient(135deg, var(--success-green) 0%, #22c55e 100%);
            color: #1f2937;
            border-style: solid;
            border-color: var(--success-green);
        }
        
        .appt-marker.priority {
            background: linear-gradient(135deg, var(--warning-yellow) 0%, #eab308 100%);
            color: #1f2937;
            border-style: solid;
            border-color: var(--warning-yellow);
        }
        
        .appt-marker.cancelled {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #F0F2F5;
            border-style: solid;
            border-color: #ef4444;
            position: relative;
        }
        
        .appt-marker.cancelled::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: white;
            transform: rotate(-45deg);
        }
        
        .total-cell {
            text-align: center;
            font-weight: 700;
            font-size: 28px;
            color: var(--primary-red);
            font-family: 'Bebas Neue', cursive;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 2px;
        }
        
        .availability-info {
            font-size: 11px;
            color: var(--soft-text);
            font-weight: 500;
            font-family: 'Work Sans', sans-serif;
        }
        
        .daily-totals-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(42, 46, 61, 0.5);
            border-top: 3px solid var(--ppw-crimson);
            border-bottom: 3px solid var(--ppw-crimson);
        }
        
        .goal-progress {
            font-size: 12px;
            font-family: 'Work Sans', sans-serif;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        /* Priority 4: Higher contrast progress badges */
        .goal-progress.met {
            background: #10b981;
            color: #fff;
            font-weight: 700;
        }
        
        .goal-progress.close {
            background: #f59e0b;
            color: #000;
            font-weight: 700;
        }
        
        .goal-progress.behind {
            background: #ef4444;
            color: #fff;
            font-weight: 700;
        }
        
        .cancellation-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(119, 10, 10, 0.12);
            border-top: 2px solid rgba(119, 10, 10, 0.5);
            border-bottom: 2px solid rgba(119, 10, 10, 0.5);
            padding: 8px 0;
        }
        
        .cancel-cell {
            text-align: center;
            font-size: 12px;
            color: var(--text-color);
            font-weight: 600;
            padding: 4px;
        }
        
        .footer {
            padding: 12px;
            text-align: center;
            background: rgba(13, 2, 2, 0.6);
        }
        
        .legend {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-box {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }
        
        .legend-box.complete {
            background: var(--success-green);
            color: #1f2937;
        }
        
        .legend-box.priority {
            background: var(--warning-yellow);
            color: #1f2937;
        }
        
        .notes-section {
            padding: 12px;
            background: rgba(20, 3, 3, 0.5);
            border-top: 2px solid var(--ppw-crimson);
        }
        
        .notes-header {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .notes-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        
        .note-item {
            background: rgba(37, 41, 54, 0.5);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(119, 10, 10, 0.35);
        }
        
        .note-label {
            font-weight: 700;
            color: var(--ppw-blue);
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .note-input {
            width: 100%;
            background: rgba(26, 29, 38, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-color);
            font-family: 'Work Sans', sans-serif;
            font-size: 13px;
            resize: vertical;
            min-height: 70px;
        }
        
        .note-input:focus {
            outline: none;
            border-color: var(--ppw-crimson);
            box-shadow: 0 0 0 2px rgba(119, 10, 10, 0.3);
        }
        
        .note-input::placeholder {
            color: #6b7280;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: rgba(18, 2, 2, 0.97);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 12px;
            min-width: 280px;
            border: 2px solid var(--ppw-crimson);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 14px;
            color: var(--text-color);
        }
        
        .modal-options {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
        
        .modal-btn {
            padding: 12px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .modal-btn.notice {
            background: var(--success-green);
            color: #1f2937;
        }
        
        .modal-btn.priority {
            background: var(--warning-yellow);
            color: #1f2937;
        }
        
        .modal-btn.cancel {
            background: #ef4444;
            color: white;
        }
        
        .modal-btn.delete {
            background: #dc2626;
            color: white;
        }
        
        .modal-btn.close {
            background: #6b7280;
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 28px;
                letter-spacing: 4px;
            }
            .date-picker-section {
                flex-direction: column;
            }
            .note-input {
                min-height: 100px;
                font-size: 14px;
                line-height: 1.5;
            }
            .appt-marker, .add-job-btn {
                width: 52px;
                height: 52px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="auth-corner">
                <span class="auth-status" id="authStatus" style="display: none;">‚óè</span>
                <button class="auth-corner-btn" id="authorizeButton" onclick="handleAuthClick()">
                    Sign In
                </button>
                <button class="auth-corner-btn signout" id="signoutButton" onclick="handleSignoutClick()" style="display: none;">
                    Sign Out
                </button>
            </div>
            <h1 class="title">3-DAY CALL BOARD</h1>
        </div>
        
        <div class="date-picker-section">
            <button class="date-nav-btn" onclick="adjustDates(-1)" title="Previous day" aria-label="Go to previous day">
                ‚óÄ
            </button>
            <!-- Priority 2: Associated label -->
            <label class="date-picker-label" for="startDatePicker">Start Date:</label>
            <input type="date" class="date-picker-input" id="startDatePicker" onchange="applyStartDate()" />
            <button class="date-nav-btn" onclick="adjustDates(1)" title="Next day" aria-label="Go to next day">
                ‚ñ∂
            </button>
            <div class="date-preview" id="datePreview"></div>
        </div>
        
        <!-- Hidden Google controls - auto-save handles everything, UI moved to top right -->
        <div class="google-controls" style="display: none;">
            <button class="google-btn save" id="saveButton" onclick="saveToDrive(false)" disabled>
                üíæ Save Now
            </button>
            <button class="google-btn load" id="loadButton" onclick="loadFromDrive()" disabled>
                üì• Load from Drive
            </button>
        </div>
        <div class="sync-status" id="syncStatus"></div>
        <div style="text-align: center; margin: 0; padding: 6px 0; background: rgba(13, 2, 2, 0.8); border-bottom: 1px solid rgba(119, 10, 10, 0.2);">
            <a href="https://drive.google.com/drive/folders/1OFC7Zw08MgaVfnRCO3TPX17lnehVpXNU" target="_blank" style="font-size: 10px; color: var(--ppw-blue); text-decoration: none;">
                üìÅ Drive Folder
            </a>
        </div>
        
        <div class="board">
            <div class="board-scroll-wrapper">
                <div class="goals-bar" id="goalsBar"></div>
                <div class="grid-container">
                    <div class="grid-header" id="gridHeader"></div>
                    <div id="techRows"></div>
                    <div class="daily-totals-row" id="dailyTotalsRow"></div>
                    <div class="cancellation-row" id="cancellationRow"></div>
                </div>
            </div>
            
            <div class="footer">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box complete">‚ò∫</div>
                        <span>Notice Given</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box priority">P</div>
                        <span>Priority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ef4444; color: white;">C</div>
                        <span>Cancelled</span>
                    </div>
                </div>
            </div>
            
            <div class="notes-section">
                <div class="notes-header">üìù Daily Notes</div>
                <div class="notes-grid" id="notesGrid"></div>
            </div>
        </div>
    </div>
    
    <!-- Priority 2: Modal accessibility attributes -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-options">
                <button class="modal-btn notice" onclick="addAppointment('‚ò∫')">‚ò∫ Notice Given</button>
                <button class="modal-btn priority" onclick="addAppointment('P')">P Priority</button>
                <button class="modal-btn cancel" onclick="addAppointment('C')">C Cancelled</button>
                <button class="modal-btn delete" onclick="addAppointment(null)">‚úï Delete</button>
                <button class="modal-btn close" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Add Job Modal -->
    <div class="modal" id="addJobModal" role="dialog" aria-modal="true" aria-labelledby="addJobModalTitle">
        <div class="modal-content">
            <div class="modal-title" id="addJobModalTitle">Add New Job</div>
            <div class="modal-options">
                <button class="modal-btn notice" onclick="addNewJob('‚ò∫')">‚ò∫ Notice Given</button>
                <button class="modal-btn priority" onclick="addNewJob('P')">P Priority</button>
                <button class="modal-btn cancel" onclick="addNewJob('C')">C Pre-Cancelled</button>
                <button class="modal-btn close" onclick="closeAddJobModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Data
        let techs = ['Tech 1', 'Tech 2', 'Tech 3', 'Tech 4'];
        let days = [
            { id: 'td1', label: 'TD1', date: 'Feb 10', goal: 13, notes: '' },
            { id: 'td2', label: 'TD2', date: 'Feb 11', goal: 9, notes: '' },
            { id: 'td3', label: 'TD3', date: 'Feb 12', goal: 5, notes: '' }
        ];
        
        // Date-based storage: stores all data for each unique date
        let dateStorage = {}; // Format: { "2/10/2026": { data: {...}, goals: {...}, notes: {...} } }
        
        let data = {};
        techs.forEach(tech => {
            data[tech] = {};
            days.forEach(day => {
                data[tech][day.id] = ['‚ò∫', '‚ò∫', '‚ò∫'];
            });
        });
        
        let customRows = [];
        let currentTech = null;
        let currentDay = null;
        let currentIndex = null;
        let previousFocus = null; // Priority 2: For focus restoration
        let addJobTech = null; // For add job modal
        let addJobDay = null;
        let driveAutoSaveInterval = null; // Track auto-save interval
        let driveAutoLoadInterval = null; // Track auto-load interval for multi-device sync
        
        // Priority 1: Fixed Google OAuth callbacks (eliminated race conditions via onload)
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
                maybeEnableButtons();
            });
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) {
                        if (resp.error === 'interaction_required' || resp.error === 'login_required' || resp.error === 'access_denied') {
                            // Silent refresh needs a user click ‚Äî show one-click resume
                            showResumeButton();
                        } else {
                            localStorage.removeItem('callBoardSignedIn');
                            showStatus('Auth error: ' + (resp.error_description || resp.error), 'error');
                        }
                        return;
                    }
                    accessToken = resp.access_token;
                    gapi.client.setToken({ access_token: resp.access_token });
                    localStorage.setItem('callBoardSignedIn', 'true');
                    updateSignedInUI();
                    document.getElementById('authorizeButton').textContent = 'Sign In'; // Reset text
                    showStatus('‚úì Signed in ‚Äî auto-sync active', 'success');
                    startDriveAutoSave();
                }
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                if (localStorage.getItem('callBoardSignedIn') === 'true') {
                    showStatus('Restoring session...', '');
                    try {
                        tokenClient.requestAccessToken({ prompt: '' });
                    } catch(e) {
                        localStorage.removeItem('callBoardSignedIn');
                        showStatus('Session expired ‚Äî please sign in', '');
                    }
                } else {
                    showStatus('', '');
                }
            }
        }
        
        // Called if silent refresh was blocked ‚Äî shows one-click resume
        function showResumeButton() {
            const authorizeBtn = document.getElementById('authorizeButton');
            authorizeBtn.textContent = 'üîÑ Resume Session';
            authorizeBtn.style.display = 'inline-block';
            document.getElementById('signoutButton').style.display = 'none';
            showStatus('Click to resume your session', '');
        }
        
        function updateSignedInUI() {
            document.getElementById('signoutButton').style.display = 'inline-block';
            document.getElementById('authorizeButton').style.display = 'none';
            document.getElementById('authStatus').style.display = 'inline-block';
            document.getElementById('saveButton').disabled = false;
            document.getElementById('loadButton').disabled = false;
        }
        
        function handleAuthClick() {
            const isResume = localStorage.getItem('callBoardSignedIn') === 'true';
            tokenClient.requestAccessToken({ prompt: isResume ? '' : 'select_account' });
        }
        
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            accessToken = null;
            localStorage.removeItem('callBoardSignedIn');
            stopDriveAutoSave();
            
            document.getElementById('authorizeButton').style.display = 'inline-block';
            document.getElementById('signoutButton').style.display = 'none';
            document.getElementById('authStatus').style.display = 'none';
            document.getElementById('saveButton').disabled = true;
            document.getElementById('loadButton').disabled = true;
            showStatus('Signed out', '');
        }
        
        function showStatus(message, type = '') {
            const status = document.getElementById('syncStatus');
            status.textContent = message;
            status.className = 'sync-status ' + type;
            // Keep success messages visible (don't auto-clear for sync status)
            if (type === 'error') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = 'sync-status';
                }, 5000);
            }
        }
        
        // Auto-save to Drive functions
        // LIVE MULTI-DEVICE SYNC: 
        // - Saves to Drive every 30 seconds after sign-in
        // - Loads from Drive every 35 seconds to get updates from other devices
        // - Status shows "üîÑ Synced HH:MM:SS" to confirm sync is active
        function startDriveAutoSave() {
            // Clear any existing intervals
            if (driveAutoSaveInterval) {
                clearInterval(driveAutoSaveInterval);
            }
            if (driveAutoLoadInterval) {
                clearInterval(driveAutoLoadInterval);
            }
            
            // Save immediately on sign-in
            saveToDrive(true);
            
            // Then save every 30 seconds
            driveAutoSaveInterval = setInterval(() => {
                saveToDrive(true);
            }, 30000);
            
            // Load from Drive every 35 seconds to get updates from other devices
            // (Offset by 5 seconds to avoid conflicts with save)
            driveAutoLoadInterval = setInterval(() => {
                loadFromDrive(true); // Silent load
            }, 35000);
        }
        
        function stopDriveAutoSave() {
            if (driveAutoSaveInterval) {
                clearInterval(driveAutoSaveInterval);
                driveAutoSaveInterval = null;
            }
            if (driveAutoLoadInterval) {
                clearInterval(driveAutoLoadInterval);
                driveAutoLoadInterval = null;
            }
        }
        
        async function saveToDrive(isAutoSave = false) {
            if (!accessToken) {
                if (!isAutoSave) showStatus('Please sign in first', 'error');
                return;
            }
            if (!isAutoSave) showStatus('Saving...', '');

            saveCurrentDateData();

            // Clean dateStorage: strip old M/D keys, nulls, and empty dates
            const cleanStorage = {};
            Object.entries(dateStorage).forEach(([dateKey, entry]) => {
                if (/^\d+\/\d+$/.test(dateKey)) return; // skip old M/D format
                const cleanData = {};
                let hasAppts = false;
                techs.forEach(tech => {
                    const clean = (entry.data[tech] || []).filter(a => a !== null && a !== undefined);
                    cleanData[tech] = clean;
                    if (clean.length > 0) hasAppts = true;
                });
                const hasNotes = entry.notes && entry.notes.trim().length > 0;
                if (hasAppts || hasNotes) {
                    cleanStorage[dateKey] = { data: cleanData, goal: entry.goal, notes: entry.notes || '' };
                }
            });
            dateStorage = cleanStorage;

            // Build readable daily breakdown
            const breakdown = {};
            Object.entries(cleanStorage)
                .sort(([a], [b]) => new Date(a + ', 2026') - new Date(b + ', 2026'))
                .forEach(([dateKey, entry]) => {
                    let dayTotal = 0, dayCancelled = 0;
                    const techLines = {};
                    techs.forEach(tech => {
                        const appts = entry.data[tech] || [];
                        const notice    = appts.filter(a => a === '‚ò∫').length;
                        const priority  = appts.filter(a => a === 'P').length;
                        const cancelled = appts.filter(a => a === 'C').length;
                        dayTotal += notice + priority;
                        dayCancelled += cancelled;
                        if (appts.length > 0) {
                            const parts = [];
                            if (notice)    parts.push(notice    + ' Notice Given');
                            if (priority)  parts.push(priority  + ' Priority');
                            if (cancelled) parts.push(cancelled + ' Cancelled');
                            techLines[tech] = parts.join(', ');
                        }
                    });
                    const pct = entry.goal > 0 ? Math.round((dayTotal / entry.goal) * 100) : 0;
                    breakdown[dateKey] = {
                        ...(entry.notes ? { 'Notes': entry.notes } : {}),
                        'Goal':  entry.goal,
                        'Total': dayTotal + ' jobs (' + pct + '% of goal)' + (dayCancelled > 0 ? ' | ' + dayCancelled + ' cancelled' : ''),
                        ...techLines
                    };
                });

            // Build clean human-readable text file
            const lines = [];
            const divider = '‚ïê'.repeat(52);
            const thin    = '‚îÄ'.repeat(52);

            lines.push(divider);
            lines.push('  3-DAY CALL BOARD');
            lines.push('  Saved: ' + new Date().toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' }));
            lines.push('  View:  ' + days.map(d => d.label + ' ' + d.date).join('  |  '));
            lines.push(divider);

            // Sort dates chronologically
            const sortedDates = Object.entries(cleanStorage)
                .sort(([a], [b]) => new Date(a + ', 2026') - new Date(b + ', 2026'));

            sortedDates.forEach(([dateKey, entry]) => {
                let dayTotal = 0, dayCancelled = 0;
                const techLines = [];

                techs.forEach(tech => {
                    const appts = entry.data[tech] || [];
                    const notice    = appts.filter(a => a === '‚ò∫').length;
                    const priority  = appts.filter(a => a === 'P').length;
                    const cancelled = appts.filter(a => a === 'C').length;
                    dayTotal    += notice + priority;
                    dayCancelled += cancelled;
                    if (appts.length > 0) {
                        const parts = [];
                        if (notice)    parts.push(notice    + ' Notice Given');
                        if (priority)  parts.push(priority  + ' Priority');
                        if (cancelled) parts.push(cancelled + ' Cancelled');
                        techLines.push('    ' + tech.padEnd(10) + parts.join(', '));
                    }
                });

                const pct    = entry.goal > 0 ? Math.round((dayTotal / entry.goal) * 100) : 0;
                const status = dayTotal >= entry.goal ? '‚úì GOAL MET' : pct + '% of goal';

                lines.push('');
                lines.push('  ' + dateKey);
                lines.push(thin);
                if (entry.notes) lines.push('  Notes: ' + entry.notes);
                lines.push('  Goal:  ' + entry.goal + '  |  Total: ' + dayTotal + '  |  ' + status + (dayCancelled > 0 ? '  |  ' + dayCancelled + ' Cancelled' : ''));
                if (techLines.length > 0) {
                    lines.push('');
                    techLines.forEach(l => lines.push(l));
                }
            });

            lines.push('');
            lines.push(divider);
            lines.push('');

            // Append raw JSON at the bottom so the app can reload it
            lines.push('%%RAW_DATA_START%%');
            lines.push(JSON.stringify({
                version: '1.2',
                savedAt: new Date().toISOString(),
                techs, days, data, customRows,
                dateStorage: cleanStorage
            }));
            lines.push('%%RAW_DATA_END%%');

            try {
                const fileContent = lines.join('\n');
                const mimeType = 'text/plain';
                let existingFileId = null;
                const listResp = await fetch(
                    'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent("name='" + CALL_BOARD_FILENAME + "' and '" + DRIVE_FOLDER_ID + "' in parents and trashed=false") + '&fields=files(id)&spaces=drive',
                    { headers: { Authorization: 'Bearer ' + accessToken } }
                );
                const listData = await listResp.json();
                if (listData.files && listData.files.length > 0) existingFileId = listData.files[0].id;

                let uploadResp;
                if (existingFileId) {
                    uploadResp = await fetch(
                        'https://www.googleapis.com/upload/drive/v3/files/' + existingFileId + '?uploadType=media',
                        { method: 'PATCH', headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': mimeType }, body: fileContent }
                    );
                } else {
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify({ name: CALL_BOARD_FILENAME, mimeType, parents: [DRIVE_FOLDER_ID] })], { type: 'application/json' }));
                    form.append('file', new Blob([fileContent], { type: mimeType }));
                    uploadResp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                        { method: 'POST', headers: { Authorization: 'Bearer ' + accessToken }, body: form }
                    );
                }

                if (!uploadResp.ok) {
                    const errText = await uploadResp.text();
                    throw new Error('Drive upload failed (' + uploadResp.status + '): ' + errText);
                }

                const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                showStatus('üîÑ Synced ' + now, 'success');
                console.log('Drive save successful:', now);

            } catch (error) {
                console.error('Drive save error:', error.message);
                showStatus('‚úó Sync failed: ' + error.message, 'error');
            }
        }

        async function loadFromDrive(isSilent = false) {
            if (!accessToken) {
                if (!isSilent) showStatus('Please sign in first', 'error');
                return;
            }

            if (!isSilent) showStatus('Loading...', '');

            try {
                // Find file using fetch directly
                const listResp = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(`name='${CALL_BOARD_FILENAME}' and '${DRIVE_FOLDER_ID}' in parents and trashed=false`)}&fields=files(id)&spaces=drive`,
                    { headers: { Authorization: 'Bearer ' + accessToken } }
                );
                const listData = await listResp.json();

                if (!listData.files || listData.files.length === 0) {
                    if (!isSilent) showStatus('No data found in Drive', 'error');
                    return;
                }

                const fileId = listData.files[0].id;

                // Download file content using fetch directly
                const downloadResp = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    { headers: { Authorization: 'Bearer ' + accessToken } }
                );

                if (!downloadResp.ok) throw new Error('Download failed (' + downloadResp.status + ')');

                const text = await downloadResp.text();

                // Parse raw JSON block from bottom of text file
                const rawStart = text.indexOf('%%RAW_DATA_START%%');
                const rawEnd   = text.indexOf('%%RAW_DATA_END%%');
                let boardData;
                if (rawStart !== -1 && rawEnd !== -1) {
                    // New TXT format ‚Äî extract embedded JSON
                    const rawJson = text.slice(rawStart + '%%RAW_DATA_START%%'.length, rawEnd).trim();
                    boardData = JSON.parse(rawJson);
                } else {
                    // Legacy JSON format fallback
                    const saveData = JSON.parse(text);
                    boardData = saveData.RAW_DATA || saveData;
                }

                if (boardData.techs) { techs.length = 0; techs.push(...boardData.techs); }
                if (boardData.days)  { days.length = 0;  days.push(...boardData.days);  }
                if (boardData.data)  {
                    Object.keys(data).forEach(k => delete data[k]);
                    Object.assign(data, boardData.data);
                }
                if (boardData.customRows) { customRows.length = 0; customRows.push(...boardData.customRows); }
                if (boardData.dateStorage) {
                    dateStorage = boardData.dateStorage;
                    loadDateData();
                }

                renderBoard();
                if (!isSilent) showStatus('‚úì Loaded from Drive', 'success');
                console.log('Drive load successful');

            } catch (error) {
                console.error('Drive load error:', error.message);
                if (!isSilent) showStatus('‚úó Load failed: ' + error.message, 'error');
            }
        }
        
        // Date-based memory functions
        function saveCurrentDateData() {
            days.forEach((day) => {
                const dateKey = day.date;
                if (!dateStorage[dateKey]) {
                    dateStorage[dateKey] = { data: {}, goal: day.goal, notes: day.notes };
                }
                // Filter nulls so deleted slots never persist
                techs.forEach(tech => {
                    dateStorage[dateKey].data[tech] = (data[tech][day.id] || []).filter(a => a !== null && a !== undefined);
                });
                dateStorage[dateKey].goal  = day.goal;
                dateStorage[dateKey].notes = day.notes;
            });
        }
        
        function loadDateData() {
            days.forEach((day, index) => {
                const dateKey = day.date;
                if (dateStorage[dateKey]) {
                    techs.forEach(tech => {
                        // Filter nulls on load too ‚Äî cleans up old dirty data
                        data[tech][day.id] = (dateStorage[dateKey].data[tech] || []).filter(a => a !== null && a !== undefined);
                    });
                    day.goal  = dateStorage[dateKey].goal  ?? (index === 0 ? 13 : index === 1 ? 9 : 5);
                    day.notes = dateStorage[dateKey].notes || '';
                } else {
                    techs.forEach(tech => { data[tech][day.id] = []; });
                    day.goal  = (index === 0 ? 13 : index === 1 ? 9 : 5);
                    day.notes = '';
                }
            });
        }
        
        // Date functions
        function adjustDates(direction) {
            // Save current date's data before switching
            saveCurrentDateData();
            
            // Get current start date
            const startDateInput = document.getElementById('startDatePicker');
            const currentDate = new Date(startDateInput.value);
            
            // Add or subtract one day
            currentDate.setDate(currentDate.getDate() + direction);
            
            // Update input
            const dateStr = currentDate.toISOString().split('T')[0];
            startDateInput.value = dateStr;
            
            // Apply the new dates and load data for new dates
            applyStartDate();
        }
        
        function applyStartDate() {
            // Save current data before switching dates
            saveCurrentDateData();
            
            const startDateInput = document.getElementById('startDatePicker');
            const dateValue = startDateInput.value;
            
            if (!dateValue) {
                alert('Please select a valid start date');
                return;
            }
            
            const [year, month, day] = dateValue.split('-').map(Number);
            
            days.forEach((dayObj, index) => {
                const currentDate = new Date(year, month - 1, day + index);
                // Use readable date format: "Feb 11" instead of "2/11"
                const dateStr = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dayObj.date = dateStr;
            });
            
            // Load data for the new dates
            loadDateData();
            
            updateDatePreview();
            renderBoard();
        }
        
        function updateDatePreview() {
            const preview = document.getElementById('datePreview');
            if (days.length > 0 && days[0].date) {
                const dateList = days.map(d => `${d.label}: ${d.date}`).join(' | ');
                preview.textContent = dateList;
            }
        }
        
        // Priority 3: Auto-apply today's date on first load
        function initializeDatePicker() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('startDatePicker').value = dateStr;
            updateDatePreview();
            applyStartDate(); // Auto-apply so board starts populated
        }
        
        // Priority 2: Modal with accessibility improvements
        function openModal(tech, day, index) {
            currentTech = tech;
            currentDay = day;
            currentIndex = index;
            
            // Store previous focus for restoration
            previousFocus = document.activeElement;
            
            const dayLabel = days.find(d => d.id === day).label;
            document.getElementById('modalTitle').textContent = `${tech} - ${dayLabel}`;
            const modal = document.getElementById('modal');
            modal.style.display = 'flex';
            
            // Focus first button
            setTimeout(() => {
                const firstButton = modal.querySelector('.modal-btn');
                if (firstButton) firstButton.focus();
            }, 100);
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            currentTech = null;
            currentDay = null;
            currentIndex = null;
            
            // Restore focus
            if (previousFocus) {
                previousFocus.focus();
                previousFocus = null;
            }
        }
        
        function addAppointment(type) {
            if (currentTech && currentDay !== null && currentIndex !== null) {
                if (type === null) {
                    // Delete: Remove the appointment from the array completely
                    data[currentTech][currentDay].splice(currentIndex, 1);
                } else {
                    // Update: Change the appointment type
                    data[currentTech][currentDay][currentIndex] = type;
                }
                renderBoard();
                closeModal();
            }
        }
        
        // Priority 2: Keyboard and backdrop handlers for modal
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('modal');
            const addJobModal = document.getElementById('addJobModal');
            if (modal.style.display === 'flex' && e.key === 'Escape') {
                closeModal();
            }
            if (addJobModal.style.display === 'flex' && e.key === 'Escape') {
                closeAddJobModal();
            }
        });
        
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });
        
        document.getElementById('addJobModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeAddJobModal();
            }
        });
        
        // Add Job Modal Functions
        function openAddJobModal(tech, day) {
            addJobTech = tech;
            addJobDay = day;
            
            previousFocus = document.activeElement;
            
            const dayLabel = days.find(d => d.id === day).label;
            document.getElementById('addJobModalTitle').textContent = `Add Job: ${tech} - ${dayLabel}`;
            const modal = document.getElementById('addJobModal');
            modal.style.display = 'flex';
            
            setTimeout(() => {
                const firstButton = modal.querySelector('.modal-btn');
                if (firstButton) firstButton.focus();
            }, 100);
        }
        
        function closeAddJobModal() {
            document.getElementById('addJobModal').style.display = 'none';
            addJobTech = null;
            addJobDay = null;
            
            if (previousFocus) {
                previousFocus.focus();
                previousFocus = null;
            }
        }
        
        function addNewJob(type) {
            if (addJobTech && addJobDay) {
                if (!data[addJobTech][addJobDay]) {
                    data[addJobTech][addJobDay] = [];
                }
                data[addJobTech][addJobDay].push(type);
                renderBoard();
                closeAddJobModal();
            }
        }
        
        // Rendering
        function renderGoalsBar() {
            const goalsBar = document.getElementById('goalsBar');
            goalsBar.innerHTML = '';
            goalsBar.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const emptyCell = document.createElement('div');
            emptyCell.className = 'goal-item empty';
            goalsBar.appendChild(emptyCell);
            
            days.forEach((day, index) => {
                const goalItem = document.createElement('div');
                goalItem.className = 'goal-item';
                
                const label = document.createElement('div');
                label.className = 'goal-label';
                label.textContent = `${day.label} ${day.date}`;
                
                const goalValue = document.createElement('div');
                goalValue.className = 'goal-value';
                
                const goalNum = document.createElement('span');
                goalNum.className = 'goal-number';
                goalNum.textContent = day.goal;
                
                const arrows = document.createElement('div');
                arrows.className = 'goal-arrows';
                
                // Priority 2: Keyboard-accessible arrow buttons
                const upArrow = document.createElement('div');
                upArrow.className = 'arrow-btn';
                upArrow.textContent = '‚ñ≤';
                upArrow.setAttribute('role', 'button');
                upArrow.setAttribute('tabindex', '0');
                upArrow.setAttribute('aria-label', `Increase goal for ${day.label}`);
                upArrow.onclick = () => {
                    days[index].goal = Math.max(0, days[index].goal + 1);
                    renderGoalsBar();
                    updateTotals();
                };
                upArrow.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        upArrow.onclick();
                    }
                };
                
                const downArrow = document.createElement('div');
                downArrow.className = 'arrow-btn';
                downArrow.textContent = '‚ñº';
                downArrow.setAttribute('role', 'button');
                downArrow.setAttribute('tabindex', '0');
                downArrow.setAttribute('aria-label', `Decrease goal for ${day.label}`);
                downArrow.onclick = () => {
                    days[index].goal = Math.max(0, days[index].goal - 1);
                    renderGoalsBar();
                    updateTotals();
                };
                downArrow.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        downArrow.onclick();
                    }
                };
                
                arrows.appendChild(upArrow);
                arrows.appendChild(downArrow);
                goalValue.appendChild(goalNum);
                goalValue.appendChild(arrows);
                goalItem.appendChild(label);
                goalItem.appendChild(goalValue);
                goalsBar.appendChild(goalItem);
            });
            
            const totalGoalItem = document.createElement('div');
            totalGoalItem.className = 'goal-item';
            const totalLabel = document.createElement('div');
            totalLabel.className = 'goal-label';
            totalLabel.textContent = 'Total Goal';
            const totalValue = document.createElement('div');
            totalValue.className = 'goal-value';
            const totalNum = document.createElement('span');
            totalNum.className = 'goal-number';
            totalNum.textContent = days.reduce((sum, day) => sum + day.goal, 0);
            totalValue.appendChild(totalNum);
            totalGoalItem.appendChild(totalLabel);
            totalGoalItem.appendChild(totalValue);
            goalsBar.appendChild(totalGoalItem);
        }
        
        function renderHeader() {
            const header = document.getElementById('gridHeader');
            header.innerHTML = '';
            header.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const techLabel = document.createElement('div');
            techLabel.textContent = 'Technician';
            header.appendChild(techLabel);
            
            days.forEach(day => {
                const dayCell = document.createElement('div');
                dayCell.textContent = `${day.label} ${day.date}`;
                header.appendChild(dayCell);
            });
            
            const totalLabel = document.createElement('div');
            totalLabel.textContent = 'Total';
            header.appendChild(totalLabel);
        }
        
        function renderTechRows() {
            const techRows = document.getElementById('techRows');
            techRows.innerHTML = '';
            
            techs.forEach(tech => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
                
                const techNameCell = document.createElement('div');
                techNameCell.className = 'tech-name';
                techNameCell.textContent = tech;
                row.appendChild(techNameCell);
                
                days.forEach(day => {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    
                    const appointments = data[tech][day.id] || [];
                    appointments.forEach((appt, index) => {
                        const marker = document.createElement('div');
                        marker.className = 'appt-marker';
                        
                        // Priority 2: Keyboard-accessible markers
                        marker.setAttribute('role', 'button');
                        marker.setAttribute('tabindex', '0');
                        
                        if (appt === '‚ò∫') {
                            marker.classList.add('filled');
                            marker.textContent = '‚ò∫';
                            marker.setAttribute('aria-label', 'Appointment: Notice given');
                        } else if (appt === 'P') {
                            marker.classList.add('priority');
                            marker.textContent = 'P';
                            marker.setAttribute('aria-label', 'Appointment: Priority');
                        } else if (appt === 'C') {
                            marker.classList.add('cancelled');
                            marker.textContent = 'C';
                            marker.setAttribute('aria-label', 'Appointment: Cancelled');
                        } else {
                            marker.classList.add('empty');
                            marker.setAttribute('aria-label', 'Empty appointment slot - click to add');
                        }
                        
                        marker.onclick = () => openModal(tech, day.id, index);
                        marker.onkeydown = (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                openModal(tech, day.id, index);
                            }
                        };
                        
                        dayCell.appendChild(marker);
                    });
                    
                    // Add "+" button to add new jobs
                    const addBtn = document.createElement('div');
                    addBtn.className = 'add-job-btn';
                    addBtn.textContent = '+';
                    addBtn.setAttribute('role', 'button');
                    addBtn.setAttribute('tabindex', '0');
                    addBtn.setAttribute('aria-label', `Add job for ${tech} on ${day.label}`);
                    addBtn.onclick = () => openAddJobModal(tech, day.id);
                    addBtn.onkeydown = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            openAddJobModal(tech, day.id);
                        }
                    };
                    dayCell.appendChild(addBtn);
                    
                    row.appendChild(dayCell);
                });
                
                const total = document.createElement('div');
                total.className = 'total-cell';
                
                const totalNum = document.createElement('div');
                totalNum.className = 'total-number';
                totalNum.textContent = calculateTechTotal(tech);
                total.appendChild(totalNum);
                
                let openSlots = 0;
                days.forEach(day => {
                    const dayAppts = data[tech][day.id] || [];
                    const emptyCount = dayAppts.filter(a => !a).length;
                    openSlots += emptyCount;
                });
                
                if (openSlots > 0) {
                    const availInfo = document.createElement('div');
                    availInfo.className = 'availability-info';
                    availInfo.textContent = `${openSlots} open slot${openSlots !== 1 ? 's' : ''}`;
                    total.appendChild(availInfo);
                }
                
                row.appendChild(total);
                techRows.appendChild(row);
            });
        }
        
        // Priority 3: Build structure once, update numbers only in updateTotals
        function renderDailyTotals() {
            const totalsRow = document.getElementById('dailyTotalsRow');
            
            // Only build structure if empty (prevents flicker/double-render)
            if (totalsRow.children.length === 0) {
                totalsRow.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
                
                const label = document.createElement('div');
                label.className = 'tech-name';
                label.textContent = 'Daily Totals';
                totalsRow.appendChild(label);
                
                days.forEach(day => {
                    const cell = document.createElement('div');
                    cell.className = 'total-cell';
                    cell.id = `total-${day.id}`;
                    
                    const totalNum = document.createElement('div');
                    totalNum.className = 'total-number';
                    totalNum.textContent = '0';
                    cell.appendChild(totalNum);
                    
                    const progress = document.createElement('div');
                    progress.className = 'goal-progress';
                    progress.id = `progress-${day.id}`;
                    progress.textContent = `0/${day.goal}`;
                    cell.appendChild(progress);
                    
                    totalsRow.appendChild(cell);
                });
                
                const grandTotal = document.createElement('div');
                grandTotal.className = 'total-cell';
                grandTotal.id = 'grand-total';
                
                const grandNum = document.createElement('div');
                grandNum.className = 'total-number';
                grandNum.textContent = '0';
                grandTotal.appendChild(grandNum);
                
                const grandProgress = document.createElement('div');
                grandProgress.className = 'goal-progress';
                grandProgress.id = 'grand-progress';
                grandProgress.textContent = '0/27';
                grandTotal.appendChild(grandProgress);
                
                totalsRow.appendChild(grandTotal);
            }
        }
        
        function renderCancellationRow() {
            const cancelRow = document.getElementById('cancellationRow');
            cancelRow.innerHTML = '';
            cancelRow.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const label = document.createElement('div');
            label.className = 'tech-name';
            label.textContent = 'Cancellation Factor';
            cancelRow.appendChild(label);
            
            let totalCancelled = 0;
            let totalAll = 0;
            
            days.forEach(day => {
                let dayCancelled = 0;
                let dayTotal = 0;
                
                techs.forEach(tech => {
                    const appts = data[tech][day.id] || [];
                    dayCancelled += appts.filter(a => a === 'C').length;
                    dayTotal += appts.filter(a => a).length;
                });
                
                totalCancelled += dayCancelled;
                totalAll += dayTotal;
                
                const cell = document.createElement('div');
                cell.className = 'cancel-cell';
                
                const percentage = dayTotal > 0 ? ((dayCancelled / dayTotal) * 100).toFixed(1) : '0.0';
                cell.textContent = `${dayCancelled}/${dayTotal} (${percentage}%)`;
                cancelRow.appendChild(cell);
            });
            
            const totalCell = document.createElement('div');
            totalCell.className = 'cancel-cell';
            const totalPercentage = totalAll > 0 ? ((totalCancelled / totalAll) * 100).toFixed(1) : '0.0';
            totalCell.textContent = `${totalCancelled}/${totalAll} (${totalPercentage}%)`;
            cancelRow.appendChild(totalCell);
        }
        
        function renderNotes() {
            const notesGrid = document.getElementById('notesGrid');
            notesGrid.innerHTML = '';
            
            const placeholders = [
                "Example: Customer callbacks, special instructions, part delays, gate codes...\n‚Ä¢ Mrs. Johnson needs follow-up in 2 weeks\n‚Ä¢ Oak St property - gate code 1234\n‚Ä¢ Heavy traffic on Route 9 - add 15min buffer",
                "Example: Rescheduling needs, tech availability, priority jobs...\n‚Ä¢ Call Mr. Wilson to reschedule Thursday slot\n‚Ä¢ Tech 3 has training 2-4pm, reassign calls\n‚Ä¢ Emergency job for Smith - moved to priority",
                "Example: Parts orders, callbacks, weather alerts, team notes...\n‚Ä¢ Parts delayed for Anderson job - reschedule Friday\n‚Ä¢ Rain expected afternoon - waterproof equipment\n‚Ä¢ Team meeting 3pm - schedule around it"
            ];
            
            days.forEach((day, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';
                
                const noteLabel = document.createElement('div');
                noteLabel.className = 'note-label';
                noteLabel.textContent = `${day.label} ${day.date}`;
                
                const noteInput = document.createElement('textarea');
                noteInput.className = 'note-input';
                noteInput.id = `note-${day.id}`;
                noteInput.placeholder = placeholders[index] || placeholders[0];
                noteInput.value = day.notes || '';
                noteInput.setAttribute('aria-label', `Notes for ${day.label} ${day.date}`);
                noteInput.oninput = (e) => {
                    days[index].notes = e.target.value;
                };
                
                noteItem.appendChild(noteLabel);
                noteItem.appendChild(noteInput);
                notesGrid.appendChild(noteItem);
            });
        }
        
        function calculateTechTotal(tech) {
            let total = 0;
            days.forEach(day => {
                const appts = data[tech][day.id] || [];
                total += appts.filter(a => a && a !== 'C').length;
            });
            return total;
        }
        
        function updateTotals() {
            let overallGoal = 0;
            
            days.forEach(day => {
                let dayTotal = 0;
                techs.forEach(tech => {
                    const dayAppts = data[tech][day.id] || [];
                    const count = dayAppts.filter(a => a && a !== 'C').length;
                    dayTotal += count;
                });
                
                const totalElem = document.getElementById(`total-${day.id}`);
                if (totalElem) {
                    const numElem = totalElem.querySelector('.total-number');
                    if (numElem) numElem.textContent = dayTotal;
                }
                
                const progressElem = document.getElementById(`progress-${day.id}`);
                if (progressElem) {
                    const goal = day.goal;
                    const percentage = goal > 0 ? (dayTotal / goal) * 100 : 0;
                    
                    progressElem.textContent = `${dayTotal}/${goal}`;
                    progressElem.classList.remove('met', 'close', 'behind');
                    
                    if (dayTotal >= goal) {
                        progressElem.classList.add('met');
                    } else if (percentage >= 75) {
                        progressElem.classList.add('close');
                    } else {
                        progressElem.classList.add('behind');
                    }
                }
                
                overallGoal += day.goal;
            });
            
            let grandTotal = 0;
            techs.forEach(tech => {
                grandTotal += calculateTechTotal(tech);
            });
            
            const grandTotalElem = document.getElementById('grand-total');
            if (grandTotalElem) {
                const numElem = grandTotalElem.querySelector('.total-number');
                if (numElem) numElem.textContent = grandTotal;
                
                const progressElem = document.getElementById('grand-progress');
                if (progressElem) {
                    const percentage = overallGoal > 0 ? (grandTotal / overallGoal) * 100 : 0;
                    progressElem.textContent = `${grandTotal}/${overallGoal}`;
                    
                    progressElem.classList.remove('met', 'close', 'behind');
                    if (grandTotal >= overallGoal) {
                        progressElem.classList.add('met');
                    } else if (percentage >= 75) {
                        progressElem.classList.add('close');
                    } else {
                        progressElem.classList.add('behind');
                    }
                }
            }
        }
        
        function renderBoard() {
            renderGoalsBar();
            renderHeader();
            renderTechRows();
            renderDailyTotals(); // Builds structure once
            renderCancellationRow();
            renderNotes();
            updateTotals(); // Updates numbers only
            
            // Save current date data whenever board is re-rendered
            saveCurrentDateData();
        }
        
        // Auto-save to browser localStorage
        function saveToLocal() {
            // Save current visible data before storing
            saveCurrentDateData();
            
            const boardData = {
                version: '1.0',
                savedAt: new Date().toISOString(),
                techs: techs,
                days: days,
                data: data,
                customRows: customRows,
                dateStorage: dateStorage // Save all date memories
            };
            localStorage.setItem('callBoardData', JSON.stringify(boardData));
        }
        
        function loadFromLocal() {
            const saved = localStorage.getItem('callBoardData');
            if (!saved) return;
            
            try {
                const boardData = JSON.parse(saved);
                
                if (boardData.techs) {
                    techs.length = 0;
                    techs.push(...boardData.techs);
                }
                if (boardData.days) {
                    days.length = 0;
                    days.push(...boardData.days);
                }
                if (boardData.data) {
                    Object.keys(data).forEach(key => delete data[key]);
                    Object.assign(data, boardData.data);
                }
                if (boardData.customRows) {
                    customRows.length = 0;
                    customRows.push(...boardData.customRows);
                }
                if (boardData.dateStorage) {
                    dateStorage = boardData.dateStorage;
                    // Load data for current dates
                    loadDateData();
                }
                
                renderBoard();
            } catch (error) {
                // Silent fail for localStorage - not critical
            }
        }
        
        // Auto-save every 10 seconds
        setInterval(() => {
            saveToLocal();
        }, 10000);
        
        // Save on page unload
        window.addEventListener('beforeunload', () => {
            saveToLocal();
        });
        
        // Initialize app
        window.addEventListener('load', () => {
            loadFromLocal();
            initializeDatePicker(); // Auto-applies today's date
        });
    </script>
</body>
</html>
