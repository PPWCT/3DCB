<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-Day Call Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CLIENT_ID = '31947493557-aqbcb8n3fag89rcjnchj5p6gufuh1oda.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const CALL_BOARD_FILENAME = '3day-call-board-data.json';
        const DRIVE_FOLDER_ID = '1OFC7Zw08MgaVfnRCO3TPX17lnehVpXNU';
        
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
    </script>
    <style>
        :root {
            --primary-red: #9FA8B8;
            --light-bg: #1A1D26;
            --text-color: #D4D9E3;
            --border-color: #343847;
            --success-green: #7FA99B;
            --warning-yellow: #B8A07E;
            --tech-blue: #7B9EB3;
            --cancel-red: #A08B8B;
            --dark-bg: #13151C;
            --soft-text: #B0B8C3;
            --glow-blue: rgba(123, 158, 179, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: #13151C;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-color);
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 30% 40%, var(--glow-blue) 0%, transparent 40%),
                radial-gradient(circle at 70% 60%, rgba(159, 168, 184, 0.12) 0%, transparent 40%);
            animation: gentleBreath 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes gentleBreath {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .title {
            font-family: 'Bebas Neue', cursive;
            font-size: 52px;
            color: #B0B8C3;
            letter-spacing: 8px;
            margin-bottom: 5px;
            text-shadow: 0 0 20px rgba(123, 158, 179, 0.3);
        }
        
        .subtitle {
            font-size: 14px;
            color: var(--text-color);
            font-weight: 600;
            opacity: 0.9;
        }
        
        .date-picker-section {
            background: rgba(37, 41, 54, 0.5);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            border: 1px solid rgba(123, 158, 179, 0.12);
        }
        
        .date-picker-label {
            font-weight: 700;
            color: var(--text-color);
        }
        
        .date-picker-input {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            background: rgba(37, 41, 54, 0.6);
            cursor: pointer;
        }
        
        .apply-dates-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, #7B9EB3 0%, #6B7A8F 100%);
            color: #F0F2F5;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .apply-dates-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(123, 158, 179, 0.4);
        }
        
        .date-preview {
            font-size: 14px;
            color: #6C757D;
        }
        
        .google-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .google-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .google-btn.signin {
            background: #4285f4;
            color: white;
        }
        
        .google-btn.save {
            background: linear-gradient(135deg, #7FA99B 0%, #6B8F82 100%);
            color: #F0F2F5;
        }
        
        .google-btn.load {
            background: linear-gradient(135deg, #7B9EB3 0%, #6B7A8F 100%);
            color: #F0F2F5;
        }
        
        .google-btn:hover {
            transform: translateY(-2px);
        }
        
        .sync-status {
            text-align: center;
            font-size: 12px;
            color: #B0B8C3;
            margin-bottom: 15px;
        }
        
        .sync-status.success { color: #7FA99B; }
        .sync-status.error { color: #A08B8B; }
        
        .board {
            background: rgba(37, 41, 54, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid rgba(123, 158, 179, 0.15);
        }
        
        .board-scroll-wrapper {
            overflow-x: auto;
        }
        
        .goals-bar {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: linear-gradient(135deg, rgba(107, 122, 143, 0.4) 0%, rgba(123, 158, 179, 0.3) 100%);
            padding: 15px;
            gap: 15px;
            min-width: 600px;
            border-bottom: 1px solid rgba(123, 158, 179, 0.2);
        }
        
        .goal-item {
            text-align: center;
        }
        
        .goal-item.empty {
            background: transparent;
        }
        
        .goal-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 8px;
        }
        
        .goal-value {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .goal-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: #F0F2F5;
        }
        
        .goal-arrows {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .arrow-btn {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            color: var(--text-color);
            transition: all 0.2s;
        }
        
        .arrow-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .grid-container {
            min-width: 600px;
        }
        
        .grid-header {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(28, 61, 90, 0.6);
            color: var(--text-color);
            font-weight: 700;
            text-align: center;
            padding: 15px 10px;
            border-bottom: 2px solid rgba(123, 158, 179, 0.3);
        }
        
        .grid-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            border-bottom: 1px solid var(--border-color);
            min-height: 80px;
        }
        
        .grid-row:hover {
            background: rgba(42, 46, 61, 0.3);
        }
        
        .tech-name {
            padding: 20px;
            font-weight: 700;
            color: var(--tech-blue);
            display: flex;
            align-items: center;
            border-right: 1px solid var(--border-color);
        }
        
        .day-cell {
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--border-color);
        }
        
        .appt-marker {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px dashed var(--border-color);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .appt-marker:hover {
            transform: scale(1.1);
            border-style: solid;
        }
        
        .appt-marker.filled {
            background: linear-gradient(135deg, #7FA99B 0%, #6B8F82 100%);
            color: #F0F2F5;
            border-style: solid;
            border-color: #7FA99B;
        }
        
        .appt-marker.priority {
            background: linear-gradient(135deg, #B8A07E 0%, #A08F6D 100%);
            color: #F0F2F5;
            border-style: solid;
            border-color: #B8A07E;
        }
        
        .appt-marker.cancelled {
            background: linear-gradient(135deg, #A08B8B 0%, #8B7575 100%);
            color: #F0F2F5;
            border-style: solid;
            border-color: #A08B8B;
            position: relative;
        }
        
        .appt-marker.cancelled::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: white;
            transform: rotate(-45deg);
        }
        
        .total-cell {
            text-align: center;
            font-weight: 700;
            font-size: 32px;
            color: var(--primary-red);
            font-family: 'Bebas Neue', cursive;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
        }
        
        .availability-info {
            font-size: 12px;
            color: #6C757D;
            font-weight: 500;
            font-family: 'Work Sans', sans-serif;
        }
        
        .daily-totals-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(42, 46, 61, 0.5);
            border-top: 3px solid var(--tech-blue);
            border-bottom: 3px solid var(--tech-blue);
        }
        
        .goal-progress {
            font-size: 14px;
            font-family: 'Work Sans', sans-serif;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .goal-progress.met {
            background: #D4EDDA;
            color: #155724;
        }
        
        .goal-progress.close {
            background: #FFF3CD;
            color: #856404;
        }
        
        .goal-progress.behind {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .cancellation-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(184, 160, 126, 0.15);
            border-top: 2px solid var(--warning-yellow);
            border-bottom: 2px solid var(--warning-yellow);
            padding: 10px 0;
        }
        
        .cancel-cell {
            text-align: center;
            font-size: 14px;
            color: var(--text-color);
            font-weight: 600;
            padding: 5px;
        }
        
        .footer {
            padding: 20px;
            text-align: center;
            background: rgba(37, 41, 54, 0.3);
        }
        
        .legend {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .legend-box.complete {
            background: #7FA99B;
            color: white;
        }
        
        .legend-box.priority {
            background: #B8A07E;
            color: white;
        }
        
        .notes-section {
            padding: 20px;
            background: rgba(42, 46, 61, 0.3);
            border-top: 2px solid rgba(123, 158, 179, 0.3);
        }
        
        .notes-header {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .notes-grid {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .note-item {
            background: rgba(37, 41, 54, 0.5);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(123, 158, 179, 0.2);
        }
        
        .note-label {
            font-weight: 700;
            color: var(--tech-blue);
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .note-input {
            width: 100%;
            background: rgba(26, 29, 38, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            color: var(--text-color);
            font-family: 'Work Sans', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }
        
        .note-input:focus {
            outline: none;
            border-color: var(--tech-blue);
            box-shadow: 0 0 0 2px rgba(123, 158, 179, 0.2);
        }
        
        .note-input::placeholder {
            color: #6C757D;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: rgba(37, 41, 54, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 16px;
            min-width: 300px;
            border: 2px solid rgba(123, 158, 179, 0.3);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-color);
        }
        
        .modal-options {
            display: flex;
            gap: 15px;
            flex-direction: column;
        }
        
        .modal-btn {
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .modal-btn.notice {
            background: #7FA99B;
            color: white;
        }
        
        .modal-btn.priority {
            background: #B8A07E;
            color: white;
        }
        
        .modal-btn.cancel {
            background: #A08B8B;
            color: white;
        }
        
        .modal-btn.delete {
            background: #721C24;
            color: white;
        }
        
        .modal-btn.close {
            background: #6C757D;
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 36px;
            }
            .date-picker-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">3-DAY CALL BOARD</h1>
            <p class="subtitle">‚ò∫ = Notice window given | P = Priority | C = Cancelled</p>
        </div>
        
        <div class="date-picker-section">
            <label class="date-picker-label">Start Date:</label>
            <input type="date" class="date-picker-input" id="startDatePicker" />
            <button class="apply-dates-btn" onclick="applyStartDate()">Apply Dates</button>
            <div class="date-preview" id="datePreview"></div>
        </div>
        
        <div class="google-controls">
            <button class="google-btn signin" id="authorizeButton" onclick="handleAuthClick()">
                üîê Sign in with Google
            </button>
            <button class="google-btn save" id="saveButton" onclick="saveToDrive()" style="display: none;">
                ‚òÅÔ∏è Save to Drive
            </button>
            <button class="google-btn load" id="loadButton" onclick="loadFromDrive()" style="display: none;">
                üì• Load from Drive
            </button>
            <button class="google-btn signin" id="signoutButton" onclick="handleSignoutClick()" style="display: none;">
                üö™ Sign Out
            </button>
        </div>
        <div class="sync-status" id="syncStatus">Initializing...</div>
        <div style="text-align: center; margin-bottom: 15px;">
            <a href="https://drive.google.com/drive/folders/1OFC7Zw08MgaVfnRCO3TPX17lnehVpXNU" target="_blank" style="font-size: 11px; color: #7B9EB3; text-decoration: none;">
                üìÅ View Drive Folder
            </a>
        </div>
        
        <div class="board">
            <div class="board-scroll-wrapper">
                <div class="goals-bar" id="goalsBar"></div>
                <div class="grid-container">
                    <div class="grid-header" id="gridHeader"></div>
                    <div id="techRows"></div>
                    <div class="daily-totals-row" id="dailyTotalsRow"></div>
                    <div class="cancellation-row" id="cancellationRow"></div>
                </div>
            </div>
            
            <div class="footer">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box complete">‚ò∫</div>
                        <span>Notice Given</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box priority">P</div>
                        <span>Priority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #A08B8B; color: white;">C</div>
                        <span>Cancelled</span>
                    </div>
                </div>
            </div>
            
            <div class="notes-section">
                <div class="notes-header">üìù Daily Notes</div>
                <div class="notes-grid" id="notesGrid"></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-options">
                <button class="modal-btn notice" onclick="addAppointment('‚ò∫')">‚ò∫ Notice Given</button>
                <button class="modal-btn priority" onclick="addAppointment('P')">P Priority</button>
                <button class="modal-btn cancel" onclick="addAppointment('C')">C Cancelled</button>
                <button class="modal-btn delete" onclick="addAppointment(null)">‚úï Delete</button>
                <button class="modal-btn close" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Data
        let techs = ['Tech 1', 'Tech 2', 'Tech 3', 'Tech 4'];
        let days = [
            { id: 'td1', label: 'TD1', date: '2/10', goal: 13, notes: '' },
            { id: 'td2', label: 'TD2', date: '2/11', goal: 9, notes: '' },
            { id: 'td3', label: 'TD3', date: '2/12', goal: 5, notes: '' }
        ];
        
        let data = {};
        techs.forEach(tech => {
            data[tech] = {};
            days.forEach(day => {
                data[tech][day.id] = ['‚ò∫', '‚ò∫', '‚ò∫'];
            });
        });
        
        let customRows = [];
        let currentTech = null;
        let currentDay = null;
        let currentIndex = null;
        
        // Google Drive API
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
                maybeEnableButtons();
            });
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) {
                        showStatus('Auth failed', 'error');
                        return;
                    }
                    accessToken = gapi.client.getToken().access_token;
                    document.getElementById('signoutButton').style.display = 'inline-block';
                    document.getElementById('authorizeButton').style.display = 'none';
                    document.getElementById('saveButton').style.display = 'inline-block';
                    document.getElementById('loadButton').style.display = 'inline-block';
                    showStatus('‚úì Signed in', 'success');
                }
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                showStatus('Ready to sign in', 'success');
            }
        }
        
        function handleAuthClick() {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                accessToken = null;
                document.getElementById('authorizeButton').style.display = 'inline-block';
                document.getElementById('signoutButton').style.display = 'none';
                document.getElementById('saveButton').style.display = 'none';
                document.getElementById('loadButton').style.display = 'none';
                showStatus('Signed out', 'success');
            }
        }
        
        function showStatus(message, type = '') {
            const status = document.getElementById('syncStatus');
            status.textContent = message;
            status.className = 'sync-status ' + type;
            setTimeout(() => {
                status.textContent = '';
                status.className = 'sync-status';
            }, 3000);
        }
        
        async function saveToDrive() {
            if (!accessToken) {
                showStatus('Please sign in first', 'error');
                return;
            }
            
            showStatus('Saving...', '');
            
            try {
                const summary = {
                    "CALL BOARD BACKUP": {
                        "Saved": new Date().toLocaleString(),
                        "Week": days.map(d => `${d.label} ${d.date}`).join(', ')
                    },
                    "GOALS": {},
                    "APPOINTMENTS": {},
                    "SUMMARY": {}
                };
                
                days.forEach(day => {
                    summary.GOALS[`${day.label} ${day.date}`] = day.goal;
                    if (day.notes && day.notes.trim()) {
                        if (!summary.NOTES) summary.NOTES = {};
                        summary.NOTES[`${day.label} ${day.date}`] = day.notes;
                    }
                });
                
                let grandTotal = 0;
                techs.forEach(tech => {
                    summary.APPOINTMENTS[tech] = {};
                    let techTotal = 0;
                    
                    days.forEach(day => {
                        const appts = data[tech][day.id] || [];
                        const active = appts.filter(a => a && a !== 'C');
                        const cancelled = appts.filter(a => a === 'C').length;
                        const noticeGiven = active.filter(a => a === '‚ò∫').length;
                        const priority = active.filter(a => a === 'P').length;
                        
                        summary.APPOINTMENTS[tech][`${day.label} ${day.date}`] = {
                            "Notice Given": noticeGiven,
                            "Priority": priority,
                            "Cancelled": cancelled,
                            "Total Active": active.length
                        };
                        techTotal += active.length;
                    });
                    
                    summary.APPOINTMENTS[tech]["TECH TOTAL"] = techTotal;
                    grandTotal += techTotal;
                });
                
                days.forEach(day => {
                    let dayTotal = 0;
                    techs.forEach(tech => {
                        const appts = data[tech][day.id] || [];
                        dayTotal += appts.filter(a => a && a !== 'C').length;
                    });
                    summary.SUMMARY[`${day.label} ${day.date}`] = {
                        "Actual": dayTotal,
                        "Goal": day.goal,
                        "Status": dayTotal >= day.goal ? "‚úì MET" : `${Math.round((dayTotal/day.goal)*100)}%`
                    };
                });
                
                summary.SUMMARY["GRAND TOTAL"] = grandTotal;
                summary.SUMMARY["TOTAL GOAL"] = days.reduce((sum, day) => sum + day.goal, 0);
                
                const saveData = {
                    "READABLE_SUMMARY": summary,
                    "RAW_DATA": {
                        version: '1.0',
                        savedAt: new Date().toISOString(),
                        techs: techs,
                        days: days,
                        data: data,
                        customRows: customRows
                    }
                };
                
                const fileContent = JSON.stringify(saveData, null, 2);
                const existingFile = await findFile(CALL_BOARD_FILENAME);
                
                if (existingFile) {
                    await updateFile(existingFile.id, fileContent);
                } else {
                    await createFile(CALL_BOARD_FILENAME, fileContent);
                }
                showStatus('‚úì Saved to Drive', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showStatus('‚úó Save failed', 'error');
            }
        }
        
        async function loadFromDrive() {
            if (!accessToken) {
                showStatus('Please sign in first', 'error');
                return;
            }
            
            showStatus('Loading...', '');
            
            try {
                const file = await findFile(CALL_BOARD_FILENAME);
                if (!file) {
                    showStatus('No data found', 'error');
                    return;
                }
                
                const content = await downloadFile(file.id);
                const saveData = JSON.parse(content);
                const boardData = saveData.RAW_DATA || saveData;
                
                if (boardData.techs) {
                    techs.length = 0;
                    techs.push(...boardData.techs);
                }
                if (boardData.days) {
                    days.length = 0;
                    days.push(...boardData.days);
                }
                if (boardData.data) {
                    Object.keys(data).forEach(key => delete data[key]);
                    Object.assign(data, boardData.data);
                }
                if (boardData.customRows) {
                    customRows.length = 0;
                    customRows.push(...boardData.customRows);
                }
                
                renderBoard();
                showStatus('‚úì Loaded', 'success');
            } catch (error) {
                console.error('Load error:', error);
                showStatus('‚úó Load failed', 'error');
            }
        }
        
        async function findFile(filename) {
            const response = await gapi.client.drive.files.list({
                q: `name='${filename}' and '${DRIVE_FOLDER_ID}' in parents and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });
            return response.result.files && response.result.files.length > 0 ? response.result.files[0] : null;
        }
        
        async function createFile(filename, content) {
            const metadata = {
                name: filename,
                mimeType: 'application/json',
                parents: [DRIVE_FOLDER_ID]
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', new Blob([content], {type: 'application/json'}));
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                body: form
            });
            
            return await response.json();
        }
        
        async function updateFile(fileId, content) {
            const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }),
                body: content
            });
            
            return await response.json();
        }
        
        async function downloadFile(fileId) {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            return JSON.stringify(response.result);
        }
        
        // Date functions
        function applyStartDate() {
            const startDateInput = document.getElementById('startDatePicker');
            const dateValue = startDateInput.value;
            
            if (!dateValue) {
                alert('Please select a valid start date');
                return;
            }
            
            const [year, month, day] = dateValue.split('-').map(Number);
            
            days.forEach((dayObj, index) => {
                const currentDate = new Date(year, month - 1, day + index);
                const monthNum = currentDate.getMonth() + 1;
                const dayNum = currentDate.getDate();
                dayObj.date = `${monthNum}/${dayNum}`;
            });
            
            updateDatePreview();
            renderBoard();
        }
        
        function updateDatePreview() {
            const preview = document.getElementById('datePreview');
            if (days.length > 0 && days[0].date) {
                const dateList = days.map(d => `${d.label}: ${d.date}`).join(' | ');
                preview.textContent = dateList;
            }
        }
        
        function initializeDatePicker() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('startDatePicker').value = dateStr;
            updateDatePreview();
        }
        
        // Modal
        function openModal(tech, day, index) {
            currentTech = tech;
            currentDay = day;
            currentIndex = index;
            
            const dayLabel = days.find(d => d.id === day).label;
            document.getElementById('modalTitle').textContent = `${tech} - ${dayLabel}`;
            document.getElementById('modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            currentTech = null;
            currentDay = null;
            currentIndex = null;
        }
        
        function addAppointment(type) {
            if (currentTech && currentDay !== null && currentIndex !== null) {
                if (type === null) {
                    data[currentTech][currentDay][currentIndex] = null;
                } else {
                    data[currentTech][currentDay][currentIndex] = type;
                }
                renderBoard();
                closeModal();
            }
        }
        
        // Rendering
        function renderGoalsBar() {
            const goalsBar = document.getElementById('goalsBar');
            goalsBar.innerHTML = '';
            goalsBar.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const emptyCell = document.createElement('div');
            emptyCell.className = 'goal-item empty';
            goalsBar.appendChild(emptyCell);
            
            days.forEach((day, index) => {
                const goalItem = document.createElement('div');
                goalItem.className = 'goal-item';
                
                const label = document.createElement('div');
                label.className = 'goal-label';
                label.textContent = `${day.label} ${day.date}`;
                
                const goalValue = document.createElement('div');
                goalValue.className = 'goal-value';
                
                const goalNum = document.createElement('span');
                goalNum.className = 'goal-number';
                goalNum.textContent = day.goal;
                
                const arrows = document.createElement('div');
                arrows.className = 'goal-arrows';
                
                const upArrow = document.createElement('div');
                upArrow.className = 'arrow-btn';
                upArrow.textContent = '‚ñ≤';
                upArrow.onclick = () => {
                    days[index].goal = Math.max(0, days[index].goal + 1);
                    renderGoalsBar();
                    updateTotals();
                };
                
                const downArrow = document.createElement('div');
                downArrow.className = 'arrow-btn';
                downArrow.textContent = '‚ñº';
                downArrow.onclick = () => {
                    days[index].goal = Math.max(0, days[index].goal - 1);
                    renderGoalsBar();
                    updateTotals();
                };
                
                arrows.appendChild(upArrow);
                arrows.appendChild(downArrow);
                goalValue.appendChild(goalNum);
                goalValue.appendChild(arrows);
                goalItem.appendChild(label);
                goalItem.appendChild(goalValue);
                goalsBar.appendChild(goalItem);
            });
            
            const totalGoalItem = document.createElement('div');
            totalGoalItem.className = 'goal-item';
            const totalLabel = document.createElement('div');
            totalLabel.className = 'goal-label';
            totalLabel.textContent = 'Total Goal';
            const totalValue = document.createElement('div');
            totalValue.className = 'goal-value';
            const totalNum = document.createElement('span');
            totalNum.className = 'goal-number';
            totalNum.textContent = days.reduce((sum, day) => sum + day.goal, 0);
            totalValue.appendChild(totalNum);
            totalGoalItem.appendChild(totalLabel);
            totalGoalItem.appendChild(totalValue);
            goalsBar.appendChild(totalGoalItem);
        }
        
        function renderHeader() {
            const header = document.getElementById('gridHeader');
            header.innerHTML = '';
            header.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const techLabel = document.createElement('div');
            techLabel.textContent = 'Technician';
            header.appendChild(techLabel);
            
            days.forEach(day => {
                const dayCell = document.createElement('div');
                dayCell.textContent = `${day.label} ${day.date}`;
                header.appendChild(dayCell);
            });
            
            const totalLabel = document.createElement('div');
            totalLabel.textContent = 'Total';
            header.appendChild(totalLabel);
        }
        
        function renderTechRows() {
            const techRows = document.getElementById('techRows');
            techRows.innerHTML = '';
            
            techs.forEach(tech => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
                
                const techNameCell = document.createElement('div');
                techNameCell.className = 'tech-name';
                techNameCell.textContent = tech;
                row.appendChild(techNameCell);
                
                days.forEach(day => {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    
                    const appointments = data[tech][day.id] || [];
                    appointments.forEach((appt, index) => {
                        const marker = document.createElement('div');
                        marker.className = 'appt-marker';
                        
                        if (appt === '‚ò∫') {
                            marker.classList.add('filled');
                            marker.textContent = '‚ò∫';
                        } else if (appt === 'P') {
                            marker.classList.add('priority');
                            marker.textContent = 'P';
                        } else if (appt === 'C') {
                            marker.classList.add('cancelled');
                            marker.textContent = 'C';
                        }
                        
                        marker.onclick = () => openModal(tech, day.id, index);
                        dayCell.appendChild(marker);
                    });
                    
                    row.appendChild(dayCell);
                });
                
                const total = document.createElement('div');
                total.className = 'total-cell';
                
                const totalNum = document.createElement('div');
                totalNum.className = 'total-number';
                totalNum.textContent = calculateTechTotal(tech);
                total.appendChild(totalNum);
                
                let openSlots = 0;
                days.forEach(day => {
                    const dayAppts = data[tech][day.id] || [];
                    const emptyCount = dayAppts.filter(a => !a).length;
                    openSlots += emptyCount;
                });
                
                if (openSlots > 0) {
                    const availInfo = document.createElement('div');
                    availInfo.className = 'availability-info';
                    availInfo.textContent = `${openSlots} open slot${openSlots !== 1 ? 's' : ''}`;
                    total.appendChild(availInfo);
                }
                
                row.appendChild(total);
                techRows.appendChild(row);
            });
        }
        
        function renderDailyTotals() {
            const totalsRow = document.getElementById('dailyTotalsRow');
            totalsRow.innerHTML = '';
            totalsRow.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const label = document.createElement('div');
            label.className = 'tech-name';
            label.textContent = 'Daily Totals';
            totalsRow.appendChild(label);
            
            days.forEach(day => {
                const cell = document.createElement('div');
                cell.className = 'total-cell';
                cell.id = `total-${day.id}`;
                
                const totalNum = document.createElement('div');
                totalNum.className = 'total-number';
                totalNum.textContent = '0';
                cell.appendChild(totalNum);
                
                const progress = document.createElement('div');
                progress.className = 'goal-progress';
                progress.id = `progress-${day.id}`;
                progress.textContent = `0/${day.goal}`;
                cell.appendChild(progress);
                
                totalsRow.appendChild(cell);
            });
            
            const grandTotal = document.createElement('div');
            grandTotal.className = 'total-cell';
            grandTotal.id = 'grand-total';
            
            const grandNum = document.createElement('div');
            grandNum.className = 'total-number';
            grandNum.textContent = '0';
            grandTotal.appendChild(grandNum);
            
            const grandProgress = document.createElement('div');
            grandProgress.className = 'goal-progress';
            grandProgress.id = 'grand-progress';
            grandProgress.textContent = '0/27';
            grandTotal.appendChild(grandProgress);
            
            totalsRow.appendChild(grandTotal);
        }
        
        function renderCancellationRow() {
            const cancelRow = document.getElementById('cancellationRow');
            cancelRow.innerHTML = '';
            cancelRow.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const label = document.createElement('div');
            label.className = 'tech-name';
            label.textContent = 'Cancellation Factor';
            cancelRow.appendChild(label);
            
            let totalCancelled = 0;
            let totalAll = 0;
            
            days.forEach(day => {
                let dayCancelled = 0;
                let dayTotal = 0;
                
                techs.forEach(tech => {
                    const appts = data[tech][day.id] || [];
                    dayCancelled += appts.filter(a => a === 'C').length;
                    dayTotal += appts.filter(a => a).length;
                });
                
                totalCancelled += dayCancelled;
                totalAll += dayTotal;
                
                const cell = document.createElement('div');
                cell.className = 'cancel-cell';
                
                const percentage = dayTotal > 0 ? ((dayCancelled / dayTotal) * 100).toFixed(1) : '0.0';
                cell.textContent = `${dayCancelled}/${dayTotal} (${percentage}%)`;
                cancelRow.appendChild(cell);
            });
            
            const totalCell = document.createElement('div');
            totalCell.className = 'cancel-cell';
            const totalPercentage = totalAll > 0 ? ((totalCancelled / totalAll) * 100).toFixed(1) : '0.0';
            totalCell.textContent = `${totalCancelled}/${totalAll} (${totalPercentage}%)`;
            cancelRow.appendChild(totalCell);
        }
        
        function renderNotes() {
            const notesGrid = document.getElementById('notesGrid');
            notesGrid.innerHTML = '';
            
            const placeholders = [
                "Example: Customer callbacks, special instructions, part delays, gate codes...\n‚Ä¢ Mrs. Johnson needs follow-up in 2 weeks\n‚Ä¢ Oak St property - gate code 1234\n‚Ä¢ Heavy traffic on Route 9 - add 15min buffer",
                "Example: Rescheduling needs, tech availability, priority jobs...\n‚Ä¢ Call Mr. Wilson to reschedule Thursday slot\n‚Ä¢ Tech 3 has training 2-4pm, reassign calls\n‚Ä¢ Emergency job for Smith - moved to priority",
                "Example: Parts orders, callbacks, weather alerts, team notes...\n‚Ä¢ Parts delayed for Anderson job - reschedule Friday\n‚Ä¢ Rain expected afternoon - waterproof equipment\n‚Ä¢ Team meeting 3pm - schedule around it"
            ];
            
            days.forEach((day, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';
                
                const noteLabel = document.createElement('div');
                noteLabel.className = 'note-label';
                noteLabel.textContent = `${day.label} ${day.date}`;
                
                const noteInput = document.createElement('textarea');
                noteInput.className = 'note-input';
                noteInput.placeholder = placeholders[index] || placeholders[0];
                noteInput.value = day.notes || '';
                noteInput.oninput = (e) => {
                    days[index].notes = e.target.value;
                };
                
                noteItem.appendChild(noteLabel);
                noteItem.appendChild(noteInput);
                notesGrid.appendChild(noteItem);
            });
        }
        
        function calculateTechTotal(tech) {
            let total = 0;
            days.forEach(day => {
                const appts = data[tech][day.id] || [];
                total += appts.filter(a => a && a !== 'C').length;
            });
            return total;
        }
        
        function updateTotals() {
            renderDailyTotals();
            
            let overallGoal = 0;
            
            days.forEach(day => {
                let dayTotal = 0;
                techs.forEach(tech => {
                    const dayAppts = data[tech][day.id] || [];
                    const count = dayAppts.filter(a => a && a !== 'C').length;
                    dayTotal += count;
                });
                
                const totalElem = document.getElementById(`total-${day.id}`);
                if (totalElem) {
                    const numElem = totalElem.querySelector('.total-number');
                    if (numElem) numElem.textContent = dayTotal;
                }
                
                const progressElem = document.getElementById(`progress-${day.id}`);
                if (progressElem) {
                    const goal = day.goal;
                    const percentage = goal > 0 ? (dayTotal / goal) * 100 : 0;
                    
                    progressElem.textContent = `${dayTotal}/${goal}`;
                    progressElem.classList.remove('met', 'close', 'behind');
                    
                    if (dayTotal >= goal) {
                        progressElem.classList.add('met');
                    } else if (percentage >= 75) {
                        progressElem.classList.add('close');
                    } else {
                        progressElem.classList.add('behind');
                    }
                }
                
                overallGoal += day.goal;
            });
            
            let grandTotal = 0;
            techs.forEach(tech => {
                grandTotal += calculateTechTotal(tech);
            });
            
            const grandTotalElem = document.getElementById('grand-total');
            if (grandTotalElem) {
                const numElem = grandTotalElem.querySelector('.total-number');
                if (numElem) numElem.textContent = grandTotal;
                
                const progressElem = document.getElementById('grand-progress');
                if (progressElem) {
                    const percentage = overallGoal > 0 ? (grandTotal / overallGoal) * 100 : 0;
                    progressElem.textContent = `${grandTotal}/${overallGoal}`;
                    
                    progressElem.classList.remove('met', 'close', 'behind');
                    if (grandTotal >= overallGoal) {
                        progressElem.classList.add('met');
                    } else if (percentage >= 75) {
                        progressElem.classList.add('close');
                    } else {
                        progressElem.classList.add('behind');
                    }
                }
            }
        }
        
        function renderBoard() {
            renderGoalsBar();
            renderHeader();
            renderTechRows();
            renderDailyTotals();
            renderCancellationRow();
            renderNotes();
            updateTotals();
        }
        
        // Initialize
        window.addEventListener('load', () => {
            gapiLoaded();
            gisLoaded();
            loadFromLocal();
        });
        
        // Auto-save to browser localStorage
        function saveToLocal() {
            const boardData = {
                version: '1.0',
                savedAt: new Date().toISOString(),
                techs: techs,
                days: days,
                data: data,
                customRows: customRows
            };
            localStorage.setItem('callBoardData', JSON.stringify(boardData));
        }
        
        function loadFromLocal() {
            const saved = localStorage.getItem('callBoardData');
            if (!saved) return;
            
            try {
                const boardData = JSON.parse(saved);
                
                if (boardData.techs) {
                    techs.length = 0;
                    techs.push(...boardData.techs);
                }
                if (boardData.days) {
                    days.length = 0;
                    days.push(...boardData.days);
                }
                if (boardData.data) {
                    Object.keys(data).forEach(key => delete data[key]);
                    Object.assign(data, boardData.data);
                }
                if (boardData.customRows) {
                    customRows.length = 0;
                    customRows.push(...boardData.customRows);
                }
                
                renderBoard();
            } catch (error) {
                console.error('Load from local storage failed:', error);
            }
        }
        
        // Auto-save every 10 seconds
        setInterval(() => {
            saveToLocal();
        }, 10000);
        
        // Save on page unload
        window.addEventListener('beforeunload', () => {
            saveToLocal();
        });
        
        initializeDatePicker();
        renderBoard();
    </script>
</body>
</html>
