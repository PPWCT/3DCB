<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://accounts.google.com https://apis.google.com; connect-src 'self' https://www.googleapis.com https://accounts.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:;">
    <title>3-Day Call Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Work+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Fixed: onload handlers eliminate race conditions -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <script>
        const CLIENT_ID = '31947493557-aqbcb8n3fag89rcjnchj5p6gufuh1oda.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const CALL_BOARD_FILENAME = '3day-call-board-data.json';
        const DRIVE_FOLDER_ID = '1OFC7Zw08MgaVfnRCO3TPX17lnehVpXNU';
        
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
    </script>
    <style>
        :root {
            --primary-red: #9FA8B8;
            --light-bg: #1A1D26;
            --text-color: #e5e7eb;
            --border-color: #343847;
            --success-green: #86efac;
            --warning-yellow: #fcd34d;
            --tech-blue: #60a5fa;
            --cancel-red: #A08B8B;
            --dark-bg: #13151C;
            --soft-text: #d1d5db;
            --glow-blue: rgba(96, 165, 250, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: #13151C;
            padding: 0;
            min-height: 100vh;
            color: var(--text-color);
            position: relative;
            margin: 0;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 30% 40%, var(--glow-blue) 0%, transparent 40%),
                radial-gradient(circle at 70% 60%, rgba(159, 168, 184, 0.12) 0%, transparent 40%);
            animation: gentleBreath 14s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes gentleBreath {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.03); }
        }
        
        /* Priority 2: Focus styles for accessibility */
        *:focus-visible {
            outline: 3px solid #60a5fa;
            outline-offset: 2px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 0;
            position: relative;
            padding: 12px 16px 8px 16px;
            background: rgba(19, 21, 28, 0.8);
        }
        
        .auth-corner {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .auth-corner-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            background: rgba(96, 165, 250, 0.2);
            color: var(--tech-blue);
            border: 1px solid var(--tech-blue);
        }
        
        .auth-corner-btn:hover {
            background: rgba(96, 165, 250, 0.3);
            transform: translateY(-1px);
        }
        
        .auth-corner-btn.signout {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: #ef4444;
        }
        
        .auth-corner-btn.signout:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .auth-status {
            font-size: 11px;
            color: var(--success-green);
        }
        
        .title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--soft-text);
            letter-spacing: 6px;
            margin-bottom: 0;
            text-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
        }
        
        .subtitle {
            font-size: 14px;
            color: var(--text-color);
            font-weight: 600;
            opacity: 0.9;
        }
        
        .date-picker-section {
            background: rgba(37, 41, 54, 0.5);
            backdrop-filter: blur(10px);
            padding: 12px 16px;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border: none;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
        }
        
        .date-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--tech-blue) 0%, #3b82f6 100%);
            color: #F0F2F5;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .date-nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
        }
        
        .date-nav-btn:active {
            transform: translateY(0);
        }
        
        .date-picker-label {
            font-weight: 700;
            color: var(--text-color);
        }
        
        .date-picker-input {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            background: rgba(37, 41, 54, 0.6);
            cursor: pointer;
        }
        
        .apply-dates-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--tech-blue) 0%, #3b82f6 100%);
            color: #F0F2F5;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .apply-dates-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(96, 165, 250, 0.4);
        }
        
        .apply-dates-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .date-preview {
            font-size: 14px;
            color: var(--soft-text);
        }
        
        .google-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .google-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .google-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .google-btn.signin {
            background: #4285f4;
            color: white;
        }
        
        .google-btn.save {
            background: linear-gradient(135deg, var(--success-green) 0%, #22c55e 100%);
            color: #1f2937;
        }
        
        .google-btn.load {
            background: linear-gradient(135deg, var(--tech-blue) 0%, #3b82f6 100%);
            color: #F0F2F5;
        }
        
        .google-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .sync-status {
            text-align: center;
            font-size: 10px;
            color: var(--soft-text);
            margin: 0;
            padding: 4px 0;
            min-height: 16px;
            background: rgba(19, 21, 28, 0.5);
        }
        
        .sync-status.success { color: var(--success-green); }
        .sync-status.error { color: #ef4444; }
        
        .board {
            background: rgba(37, 41, 54, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            border: none;
        }
        
        .board-scroll-wrapper {
            overflow-x: auto;
        }
        
        .goals-bar {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(96, 165, 250, 0.2) 100%);
            padding: 10px;
            gap: 10px;
            min-width: 600px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
        }
        
        .goal-item {
            text-align: center;
        }
        
        .goal-item.empty {
            background: transparent;
        }
        
        .goal-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 4px;
        }
        
        .goal-value {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .goal-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: #F0F2F5;
        }
        
        .goal-arrows {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .arrow-btn {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            color: var(--text-color);
            transition: all 0.2s;
        }
        
        .arrow-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .grid-container {
            min-width: 600px;
        }
        
        .grid-header {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(28, 61, 90, 0.6);
            color: var(--text-color);
            font-weight: 700;
            text-align: center;
            padding: 10px 8px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
            font-size: 13px;
        }
        
        .grid-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            border-bottom: 1px solid var(--border-color);
            min-height: 70px;
        }
        
        .grid-row:hover {
            background: rgba(42, 46, 61, 0.3);
        }
        
        .tech-name {
            padding: 12px 16px;
            font-weight: 700;
            color: var(--tech-blue);
            display: flex;
            align-items: center;
            border-right: 1px solid var(--border-color);
            font-size: 14px;
        }
        
        .day-cell {
            padding: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--border-color);
            position: relative;
        }
        
        .add-job-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px dashed var(--tech-blue);
            background: rgba(96, 165, 250, 0.1);
            color: var(--tech-blue);
            font-weight: bold;
        }
        
        .add-job-btn:hover {
            transform: scale(1.1);
            background: rgba(96, 165, 250, 0.2);
            border-style: solid;
        }
        
        /* Priority 3: Larger, clearer markers */
        .appt-marker {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px dashed var(--border-color);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .appt-marker:hover {
            transform: scale(1.1);
            border-style: solid;
        }
        
        .appt-marker.filled {
            background: linear-gradient(135deg, var(--success-green) 0%, #22c55e 100%);
            color: #1f2937;
            border-style: solid;
            border-color: var(--success-green);
        }
        
        .appt-marker.priority {
            background: linear-gradient(135deg, var(--warning-yellow) 0%, #eab308 100%);
            color: #1f2937;
            border-style: solid;
            border-color: var(--warning-yellow);
        }
        
        .appt-marker.cancelled {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #F0F2F5;
            border-style: solid;
            border-color: #ef4444;
            position: relative;
        }
        
        .appt-marker.cancelled::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: white;
            transform: rotate(-45deg);
        }
        
        .total-cell {
            text-align: center;
            font-weight: 700;
            font-size: 28px;
            color: var(--primary-red);
            font-family: 'Bebas Neue', cursive;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 2px;
        }
        
        .availability-info {
            font-size: 11px;
            color: var(--soft-text);
            font-weight: 500;
            font-family: 'Work Sans', sans-serif;
        }
        
        .daily-totals-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(42, 46, 61, 0.5);
            border-top: 3px solid var(--tech-blue);
            border-bottom: 3px solid var(--tech-blue);
        }
        
        .goal-progress {
            font-size: 12px;
            font-family: 'Work Sans', sans-serif;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        /* Priority 4: Higher contrast progress badges */
        .goal-progress.met {
            background: #10b981;
            color: #f0fdf4;
        }
        
        .goal-progress.close {
            background: #f59e0b;
            color: #451a03;
        }
        
        .goal-progress.behind {
            background: #ef4444;
            color: #fef2f2;
        }
        
        .cancellation-row {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr) 150px;
            background: rgba(252, 211, 77, 0.15);
            border-top: 2px solid var(--warning-yellow);
            border-bottom: 2px solid var(--warning-yellow);
            padding: 8px 0;
        }
        
        .cancel-cell {
            text-align: center;
            font-size: 12px;
            color: var(--text-color);
            font-weight: 600;
            padding: 4px;
        }
        
        .footer {
            padding: 12px;
            text-align: center;
            background: rgba(37, 41, 54, 0.3);
        }
        
        .legend {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-box {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }
        
        .legend-box.complete {
            background: var(--success-green);
            color: #1f2937;
        }
        
        .legend-box.priority {
            background: var(--warning-yellow);
            color: #1f2937;
        }
        
        .notes-section {
            padding: 12px;
            background: rgba(42, 46, 61, 0.3);
            border-top: 2px solid rgba(96, 165, 250, 0.3);
        }
        
        .notes-header {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .notes-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        
        .note-item {
            background: rgba(37, 41, 54, 0.5);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }
        
        .note-label {
            font-weight: 700;
            color: var(--tech-blue);
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .note-input {
            width: 100%;
            background: rgba(26, 29, 38, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-color);
            font-family: 'Work Sans', sans-serif;
            font-size: 13px;
            resize: vertical;
            min-height: 70px;
        }
        
        .note-input:focus {
            outline: none;
            border-color: var(--tech-blue);
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }
        
        .note-input::placeholder {
            color: #6b7280;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: rgba(37, 41, 54, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 12px;
            min-width: 280px;
            border: 2px solid rgba(96, 165, 250, 0.3);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 14px;
            color: var(--text-color);
        }
        
        .modal-options {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
        
        .modal-btn {
            padding: 12px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .modal-btn.notice {
            background: var(--success-green);
            color: #1f2937;
        }
        
        .modal-btn.priority {
            background: var(--warning-yellow);
            color: #1f2937;
        }
        
        .modal-btn.cancel {
            background: #ef4444;
            color: white;
        }
        
        .modal-btn.delete {
            background: #dc2626;
            color: white;
        }
        
        .modal-btn.close {
            background: #6b7280;
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 28px;
                letter-spacing: 4px;
            }
            .date-picker-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="auth-corner">
                <span class="auth-status" id="authStatus" style="display: none;">‚óè</span>
                <button class="auth-corner-btn" id="authorizeButton" onclick="handleAuthClick()">
                    Sign In
                </button>
                <button class="auth-corner-btn signout" id="signoutButton" onclick="handleSignoutClick()" style="display: none;">
                    Sign Out
                </button>
            </div>
            <h1 class="title">3-DAY CALL BOARD</h1>
        </div>
        
        <div class="date-picker-section">
            <button class="date-nav-btn" onclick="adjustDates(-1)" title="Previous day" aria-label="Go to previous day">
                ‚óÄ
            </button>
            <!-- Priority 2: Associated label -->
            <label class="date-picker-label" for="startDatePicker">Start Date:</label>
            <input type="date" class="date-picker-input" id="startDatePicker" onchange="applyStartDate()" />
            <button class="date-nav-btn" onclick="adjustDates(1)" title="Next day" aria-label="Go to next day">
                ‚ñ∂
            </button>
            <div class="date-preview" id="datePreview"></div>
        </div>
        
        <!-- Hidden Google controls - auto-save handles everything, UI moved to top right -->
        <div class="google-controls" style="display: none;">
            <button class="google-btn save" id="saveButton" onclick="saveToDrive(false)" disabled>
                üíæ Save Now
            </button>
            <button class="google-btn load" id="loadButton" onclick="loadFromDrive()" disabled>
                üì• Load from Drive
            </button>
        </div>
        <div class="sync-status" id="syncStatus"></div>
        <div style="text-align: center; margin: 0; padding: 6px 0; background: rgba(19, 21, 28, 0.5); border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
            <a href="https://drive.google.com/drive/folders/1OFC7Zw08MgaVfnRCO3TPX17lnehVpXNU" target="_blank" style="font-size: 10px; color: var(--tech-blue); text-decoration: none;">
                üìÅ Drive Folder
            </a>
        </div>
        
        <div class="board">
            <div class="board-scroll-wrapper">
                <div class="goals-bar" id="goalsBar"></div>
                <div class="grid-container">
                    <div class="grid-header" id="gridHeader"></div>
                    <div id="techRows"></div>
                    <div class="daily-totals-row" id="dailyTotalsRow"></div>
                    <div class="cancellation-row" id="cancellationRow"></div>
                </div>
            </div>
            
            <div class="footer">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box complete">‚ò∫</div>
                        <span>Notice Given</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box priority">P</div>
                        <span>Priority</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ef4444; color: white;">C</div>
                        <span>Cancelled</span>
                    </div>
                </div>
            </div>
            
            <div class="notes-section">
                <div class="notes-header">üìù Daily Notes</div>
                <div class="notes-grid" id="notesGrid"></div>
            </div>
        </div>
    </div>
    
    <!-- Priority 2: Modal accessibility attributes -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div class="modal-options">
                <button class="modal-btn notice" onclick="addAppointment('‚ò∫')">‚ò∫ Notice Given</button>
                <button class="modal-btn priority" onclick="addAppointment('P')">P Priority</button>
                <button class="modal-btn cancel" onclick="addAppointment('C')">C Cancelled</button>
                <button class="modal-btn delete" onclick="addAppointment(null)">‚úï Delete</button>
                <button class="modal-btn close" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Add Job Modal -->
    <div class="modal" id="addJobModal" role="dialog" aria-modal="true" aria-labelledby="addJobModalTitle">
        <div class="modal-content">
            <div class="modal-title" id="addJobModalTitle">Add New Job</div>
            <div class="modal-options">
                <button class="modal-btn notice" onclick="addNewJob('‚ò∫')">‚ò∫ Notice Given</button>
                <button class="modal-btn priority" onclick="addNewJob('P')">P Priority</button>
                <button class="modal-btn cancel" onclick="addNewJob('C')">C Cancelled</button>
                <button class="modal-btn close" onclick="closeAddJobModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Data
        let techs = ['Tech 1', 'Tech 2', 'Tech 3', 'Tech 4'];
        let days = [
            { id: 'td1', label: 'TD1', date: '2/10', goal: 13, notes: '' },
            { id: 'td2', label: 'TD2', date: '2/11', goal: 9, notes: '' },
            { id: 'td3', label: 'TD3', date: '2/12', goal: 5, notes: '' }
        ];
        
        // Date-based storage: stores all data for each unique date
        let dateStorage = {}; // Format: { "2/10/2026": { data: {...}, goals: {...}, notes: {...} } }
        
        let data = {};
        techs.forEach(tech => {
            data[tech] = {};
            days.forEach(day => {
                data[tech][day.id] = ['‚ò∫', '‚ò∫', '‚ò∫'];
            });
        });
        
        let customRows = [];
        let currentTech = null;
        let currentDay = null;
        let currentIndex = null;
        let previousFocus = null; // Priority 2: For focus restoration
        let addJobTech = null; // For add job modal
        let addJobDay = null;
        let driveAutoSaveInterval = null; // Track auto-save interval
        let driveAutoLoadInterval = null; // Track auto-load interval for multi-device sync
        
        // Priority 1: Fixed Google OAuth callbacks (eliminated race conditions via onload)
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
                maybeEnableButtons();
            });
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) {
                        showStatus('Auth failed: ' + (resp.error_description || resp.error), 'error');
                        return;
                    }
                    // Priority 1: Correctly set token from response
                    accessToken = resp.access_token;
                    gapi.client.setToken({ access_token: resp.access_token });
                    
                    // Priority 1: Update UI state reliably
                    document.getElementById('signoutButton').style.display = 'inline-block';
                    document.getElementById('authorizeButton').style.display = 'none';
                    document.getElementById('authStatus').style.display = 'inline-block';
                    document.getElementById('saveButton').disabled = false;
                    document.getElementById('loadButton').disabled = false;
                    showStatus('‚úì Signed in - Auto-save enabled', 'success');
                    
                    // Start auto-save to Drive every 30 seconds
                    startDriveAutoSave();
                }
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                showStatus('Ready to sign in', 'success');
            }
        }
        
        function handleAuthClick() {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                accessToken = null;
                
                // Stop auto-save interval
                stopDriveAutoSave();
                
                // Priority 1: Correctly reset UI state
                document.getElementById('authorizeButton').style.display = 'inline-block';
                document.getElementById('signoutButton').style.display = 'none';
                document.getElementById('authStatus').style.display = 'none';
                document.getElementById('saveButton').disabled = true;
                document.getElementById('loadButton').disabled = true;
                showStatus('Signed out', 'success');
            }
        }
        
        function showStatus(message, type = '') {
            const status = document.getElementById('syncStatus');
            status.textContent = message;
            status.className = 'sync-status ' + type;
            // Keep success messages visible (don't auto-clear for sync status)
            if (type === 'error') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = 'sync-status';
                }, 5000);
            }
        }
        
        // Auto-save to Drive functions
        // LIVE MULTI-DEVICE SYNC: 
        // - Saves to Drive every 30 seconds after sign-in
        // - Loads from Drive every 35 seconds to get updates from other devices
        // - Status shows "üîÑ Synced HH:MM:SS" to confirm sync is active
        function startDriveAutoSave() {
            // Clear any existing intervals
            if (driveAutoSaveInterval) {
                clearInterval(driveAutoSaveInterval);
            }
            if (driveAutoLoadInterval) {
                clearInterval(driveAutoLoadInterval);
            }
            
            // Save immediately on sign-in
            saveToDrive(true);
            
            // Then save every 30 seconds
            driveAutoSaveInterval = setInterval(() => {
                saveToDrive(true);
            }, 30000);
            
            // Load from Drive every 35 seconds to get updates from other devices
            // (Offset by 5 seconds to avoid conflicts with save)
            driveAutoLoadInterval = setInterval(() => {
                loadFromDrive(true); // Silent load
            }, 35000);
        }
        
        function stopDriveAutoSave() {
            if (driveAutoSaveInterval) {
                clearInterval(driveAutoSaveInterval);
                driveAutoSaveInterval = null;
            }
            if (driveAutoLoadInterval) {
                clearInterval(driveAutoLoadInterval);
                driveAutoLoadInterval = null;
            }
        }
        
        async function saveToDrive(isAutoSave = false) {
            if (!accessToken) {
                showStatus('Please sign in first', 'error');
                return;
            }
            
            // Only show "Saving..." for manual saves
            if (!isAutoSave) {
                showStatus('Saving...', '');
            }
            
            // Save current visible data before creating backup
            saveCurrentDateData();
            
            try {
                const summary = {
                    "CALL BOARD BACKUP": {
                        "Saved": new Date().toLocaleString(),
                        "Week": days.map(d => `${d.label} ${d.date}`).join(', ')
                    },
                    "GOALS": {},
                    "APPOINTMENTS": {},
                    "SUMMARY": {}
                };
                
                days.forEach(day => {
                    summary.GOALS[`${day.label} ${day.date}`] = day.goal;
                    if (day.notes && day.notes.trim()) {
                        if (!summary.NOTES) summary.NOTES = {};
                        summary.NOTES[`${day.label} ${day.date}`] = day.notes;
                    }
                });
                
                let grandTotal = 0;
                techs.forEach(tech => {
                    summary.APPOINTMENTS[tech] = {};
                    let techTotal = 0;
                    
                    days.forEach(day => {
                        const appts = data[tech][day.id] || [];
                        const active = appts.filter(a => a && a !== 'C');
                        const cancelled = appts.filter(a => a === 'C').length;
                        const noticeGiven = active.filter(a => a === '‚ò∫').length;
                        const priority = active.filter(a => a === 'P').length;
                        
                        summary.APPOINTMENTS[tech][`${day.label} ${day.date}`] = {
                            "Notice Given": noticeGiven,
                            "Priority": priority,
                            "Cancelled": cancelled,
                            "Total Active": active.length
                        };
                        techTotal += active.length;
                    });
                    
                    summary.APPOINTMENTS[tech]["TECH TOTAL"] = techTotal;
                    grandTotal += techTotal;
                });
                
                days.forEach(day => {
                    let dayTotal = 0;
                    techs.forEach(tech => {
                        const appts = data[tech][day.id] || [];
                        dayTotal += appts.filter(a => a && a !== 'C').length;
                    });
                    summary.SUMMARY[`${day.label} ${day.date}`] = {
                        "Actual": dayTotal,
                        "Goal": day.goal,
                        "Status": dayTotal >= day.goal ? "‚úì MET" : `${Math.round((dayTotal/day.goal)*100)}%`
                    };
                });
                
                summary.SUMMARY["GRAND TOTAL"] = grandTotal;
                summary.SUMMARY["TOTAL GOAL"] = days.reduce((sum, day) => sum + day.goal, 0);
                
                const saveData = {
                    "READABLE_SUMMARY": summary,
                    "RAW_DATA": {
                        version: '1.0',
                        savedAt: new Date().toISOString(),
                        techs: techs,
                        days: days,
                        data: data,
                        customRows: customRows,
                        dateStorage: dateStorage // Save all date memories
                    }
                };
                
                const fileContent = JSON.stringify(saveData, null, 2);
                const existingFile = await findFile(CALL_BOARD_FILENAME);
                
                if (existingFile) {
                    await updateFile(existingFile.id, fileContent);
                } else {
                    await createFile(CALL_BOARD_FILENAME, fileContent);
                }
                
                // Show different messages for auto vs manual save
                if (isAutoSave) {
                    // Silent auto-save with timestamp
                    const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    showStatus(`üîÑ Synced ${now}`, 'success');
                } else {
                    showStatus('‚úì Saved to Drive', 'success');
                }
            } catch (error) {
                // Priority 1: Better error messages (no sensitive logging)
                if (!isAutoSave) {
                    showStatus('‚úó Save failed: ' + (error.message || 'Unknown error'), 'error');
                }
                // Silent fail for auto-save to avoid spamming user
            }
        }
        
        async function loadFromDrive(isSilent = false) {
            if (!accessToken) {
                if (!isSilent) {
                    showStatus('Please sign in first', 'error');
                }
                return;
            }
            
            if (!isSilent) {
                showStatus('Loading...', '');
            }
            
            try {
                const file = await findFile(CALL_BOARD_FILENAME);
                if (!file) {
                    showStatus('No data found in Drive', 'error');
                    return;
                }
                
                const content = await downloadFile(file.id);
                const saveData = JSON.parse(content);
                const boardData = saveData.RAW_DATA || saveData;
                
                if (boardData.techs) {
                    techs.length = 0;
                    techs.push(...boardData.techs);
                }
                if (boardData.days) {
                    days.length = 0;
                    days.push(...boardData.days);
                }
                if (boardData.data) {
                    Object.keys(data).forEach(key => delete data[key]);
                    Object.assign(data, boardData.data);
                }
                if (boardData.customRows) {
                    customRows.length = 0;
                    customRows.push(...boardData.customRows);
                }
                if (boardData.dateStorage) {
                    dateStorage = boardData.dateStorage;
                    loadDateData(); // Load data for current visible dates
                }
                
                renderBoard();
                if (!isSilent) {
                    showStatus('‚úì Loaded from Drive', 'success');
                }
            } catch (error) {
                if (!isSilent) {
                    showStatus('‚úó Load failed: ' + (error.message || 'Unknown error'), 'error');
                }
            }
        }
        
        async function findFile(filename) {
            const response = await gapi.client.drive.files.list({
                q: `name='${filename}' and '${DRIVE_FOLDER_ID}' in parents and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });
            return response.result.files && response.result.files.length > 0 ? response.result.files[0] : null;
        }
        
        async function createFile(filename, content) {
            const metadata = {
                name: filename,
                mimeType: 'application/json',
                parents: [DRIVE_FOLDER_ID]
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', new Blob([content], {type: 'application/json'}));
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                body: form
            });
            
            if (!response.ok) {
                throw new Error('Upload failed: ' + response.statusText);
            }
            
            return await response.json();
        }
        
        async function updateFile(fileId, content) {
            const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }),
                body: content
            });
            
            if (!response.ok) {
                throw new Error('Update failed: ' + response.statusText);
            }
            
            return await response.json();
        }
        
        // Priority 1: Fixed downloadFile to return raw JSON string
        async function downloadFile(fileId) {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            
            // Return raw body if available, otherwise stringify result
            return response.body || JSON.stringify(response.result);
        }
        
        // Date-based memory functions
        function saveCurrentDateData() {
            // Save current board state to each date's storage
            days.forEach((day, index) => {
                const dateKey = day.date; // e.g., "2/10"
                
                if (!dateStorage[dateKey]) {
                    dateStorage[dateKey] = {
                        data: {},
                        goal: day.goal,
                        notes: day.notes
                    };
                }
                
                // Save appointments for this specific date
                dateStorage[dateKey].data = {};
                techs.forEach(tech => {
                    dateStorage[dateKey].data[tech] = [...(data[tech][day.id] || [])];
                });
                
                // Save goal and notes
                dateStorage[dateKey].goal = day.goal;
                dateStorage[dateKey].notes = day.notes;
            });
        }
        
        function loadDateData() {
            // Load data for the current dates being displayed
            days.forEach((day, index) => {
                const dateKey = day.date;
                
                if (dateStorage[dateKey]) {
                    // Restore appointments
                    techs.forEach(tech => {
                        if (dateStorage[dateKey].data[tech]) {
                            data[tech][day.id] = [...dateStorage[dateKey].data[tech]];
                        } else {
                            data[tech][day.id] = [];
                        }
                    });
                    
                    // Restore goal and notes
                    day.goal = dateStorage[dateKey].goal || (index === 0 ? 13 : index === 1 ? 9 : 5);
                    day.notes = dateStorage[dateKey].notes || '';
                } else {
                    // New date - initialize with empty data
                    techs.forEach(tech => {
                        data[tech][day.id] = [];
                    });
                    day.goal = (index === 0 ? 13 : index === 1 ? 9 : 5);
                    day.notes = '';
                }
            });
        }
        
        // Date functions
        function adjustDates(direction) {
            // Save current date's data before switching
            saveCurrentDateData();
            
            // Get current start date
            const startDateInput = document.getElementById('startDatePicker');
            const currentDate = new Date(startDateInput.value);
            
            // Add or subtract one day
            currentDate.setDate(currentDate.getDate() + direction);
            
            // Update input
            const dateStr = currentDate.toISOString().split('T')[0];
            startDateInput.value = dateStr;
            
            // Apply the new dates and load data for new dates
            applyStartDate();
        }
        
        function applyStartDate() {
            // Save current data before switching dates
            saveCurrentDateData();
            
            const startDateInput = document.getElementById('startDatePicker');
            const dateValue = startDateInput.value;
            
            if (!dateValue) {
                alert('Please select a valid start date');
                return;
            }
            
            const [year, month, day] = dateValue.split('-').map(Number);
            
            days.forEach((dayObj, index) => {
                const currentDate = new Date(year, month - 1, day + index);
                const monthNum = currentDate.getMonth() + 1;
                const dayNum = currentDate.getDate();
                dayObj.date = `${monthNum}/${dayNum}`;
            });
            
            // Load data for the new dates
            loadDateData();
            
            updateDatePreview();
            renderBoard();
        }
        
        function updateDatePreview() {
            const preview = document.getElementById('datePreview');
            if (days.length > 0 && days[0].date) {
                const dateList = days.map(d => `${d.label}: ${d.date}`).join(' | ');
                preview.textContent = dateList;
            }
        }
        
        // Priority 3: Auto-apply today's date on first load
        function initializeDatePicker() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('startDatePicker').value = dateStr;
            updateDatePreview();
            applyStartDate(); // Auto-apply so board starts populated
        }
        
        // Priority 2: Modal with accessibility improvements
        function openModal(tech, day, index) {
            currentTech = tech;
            currentDay = day;
            currentIndex = index;
            
            // Store previous focus for restoration
            previousFocus = document.activeElement;
            
            const dayLabel = days.find(d => d.id === day).label;
            document.getElementById('modalTitle').textContent = `${tech} - ${dayLabel}`;
            const modal = document.getElementById('modal');
            modal.style.display = 'flex';
            
            // Focus first button
            setTimeout(() => {
                const firstButton = modal.querySelector('.modal-btn');
                if (firstButton) firstButton.focus();
            }, 100);
        }
        
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            currentTech = null;
            currentDay = null;
            currentIndex = null;
            
            // Restore focus
            if (previousFocus) {
                previousFocus.focus();
                previousFocus = null;
            }
        }
        
        function addAppointment(type) {
            if (currentTech && currentDay !== null && currentIndex !== null) {
                if (type === null) {
                    data[currentTech][currentDay][currentIndex] = null;
                } else {
                    data[currentTech][currentDay][currentIndex] = type;
                }
                renderBoard();
                closeModal();
            }
        }
        
        // Priority 2: Keyboard and backdrop handlers for modal
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('modal');
            const addJobModal = document.getElementById('addJobModal');
            if (modal.style.display === 'flex' && e.key === 'Escape') {
                closeModal();
            }
            if (addJobModal.style.display === 'flex' && e.key === 'Escape') {
                closeAddJobModal();
            }
        });
        
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });
        
        document.getElementById('addJobModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeAddJobModal();
            }
        });
        
        // Add Job Modal Functions
        function openAddJobModal(tech, day) {
            addJobTech = tech;
            addJobDay = day;
            
            previousFocus = document.activeElement;
            
            const dayLabel = days.find(d => d.id === day).label;
            document.getElementById('addJobModalTitle').textContent = `Add Job: ${tech} - ${dayLabel}`;
            const modal = document.getElementById('addJobModal');
            modal.style.display = 'flex';
            
            setTimeout(() => {
                const firstButton = modal.querySelector('.modal-btn');
                if (firstButton) firstButton.focus();
            }, 100);
        }
        
        function closeAddJobModal() {
            document.getElementById('addJobModal').style.display = 'none';
            addJobTech = null;
            addJobDay = null;
            
            if (previousFocus) {
                previousFocus.focus();
                previousFocus = null;
            }
        }
        
        function addNewJob(type) {
            if (addJobTech && addJobDay) {
                if (!data[addJobTech][addJobDay]) {
                    data[addJobTech][addJobDay] = [];
                }
                data[addJobTech][addJobDay].push(type);
                renderBoard();
                closeAddJobModal();
            }
        }
        
        // Rendering
        function renderGoalsBar() {
            const goalsBar = document.getElementById('goalsBar');
            goalsBar.innerHTML = '';
            goalsBar.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const emptyCell = document.createElement('div');
            emptyCell.className = 'goal-item empty';
            goalsBar.appendChild(emptyCell);
            
            days.forEach((day, index) => {
                const goalItem = document.createElement('div');
                goalItem.className = 'goal-item';
                
                const label = document.createElement('div');
                label.className = 'goal-label';
                label.textContent = `${day.label} ${day.date}`;
                
                const goalValue = document.createElement('div');
                goalValue.className = 'goal-value';
                
                const goalNum = document.createElement('span');
                goalNum.className = 'goal-number';
                goalNum.textContent = day.goal;
                
                const arrows = document.createElement('div');
                arrows.className = 'goal-arrows';
                
                // Priority 2: Keyboard-accessible arrow buttons
                const upArrow = document.createElement('div');
                upArrow.className = 'arrow-btn';
                upArrow.textContent = '‚ñ≤';
                upArrow.setAttribute('role', 'button');
                upArrow.setAttribute('tabindex', '0');
                upArrow.setAttribute('aria-label', `Increase goal for ${day.label}`);
                upArrow.onclick = () => {
                    days[index].goal = Math.max(0, days[index].goal + 1);
                    renderGoalsBar();
                    updateTotals();
                };
                upArrow.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        upArrow.onclick();
                    }
                };
                
                const downArrow = document.createElement('div');
                downArrow.className = 'arrow-btn';
                downArrow.textContent = '‚ñº';
                downArrow.setAttribute('role', 'button');
                downArrow.setAttribute('tabindex', '0');
                downArrow.setAttribute('aria-label', `Decrease goal for ${day.label}`);
                downArrow.onclick = () => {
                    days[index].goal = Math.max(0, days[index].goal - 1);
                    renderGoalsBar();
                    updateTotals();
                };
                downArrow.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        downArrow.onclick();
                    }
                };
                
                arrows.appendChild(upArrow);
                arrows.appendChild(downArrow);
                goalValue.appendChild(goalNum);
                goalValue.appendChild(arrows);
                goalItem.appendChild(label);
                goalItem.appendChild(goalValue);
                goalsBar.appendChild(goalItem);
            });
            
            const totalGoalItem = document.createElement('div');
            totalGoalItem.className = 'goal-item';
            const totalLabel = document.createElement('div');
            totalLabel.className = 'goal-label';
            totalLabel.textContent = 'Total Goal';
            const totalValue = document.createElement('div');
            totalValue.className = 'goal-value';
            const totalNum = document.createElement('span');
            totalNum.className = 'goal-number';
            totalNum.textContent = days.reduce((sum, day) => sum + day.goal, 0);
            totalValue.appendChild(totalNum);
            totalGoalItem.appendChild(totalLabel);
            totalGoalItem.appendChild(totalValue);
            goalsBar.appendChild(totalGoalItem);
        }
        
        function renderHeader() {
            const header = document.getElementById('gridHeader');
            header.innerHTML = '';
            header.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const techLabel = document.createElement('div');
            techLabel.textContent = 'Technician';
            header.appendChild(techLabel);
            
            days.forEach(day => {
                const dayCell = document.createElement('div');
                dayCell.textContent = `${day.label} ${day.date}`;
                header.appendChild(dayCell);
            });
            
            const totalLabel = document.createElement('div');
            totalLabel.textContent = 'Total';
            header.appendChild(totalLabel);
        }
        
        function renderTechRows() {
            const techRows = document.getElementById('techRows');
            techRows.innerHTML = '';
            
            techs.forEach(tech => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
                
                const techNameCell = document.createElement('div');
                techNameCell.className = 'tech-name';
                techNameCell.textContent = tech;
                row.appendChild(techNameCell);
                
                days.forEach(day => {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    
                    const appointments = data[tech][day.id] || [];
                    appointments.forEach((appt, index) => {
                        const marker = document.createElement('div');
                        marker.className = 'appt-marker';
                        
                        // Priority 2: Keyboard-accessible markers
                        marker.setAttribute('role', 'button');
                        marker.setAttribute('tabindex', '0');
                        
                        if (appt === '‚ò∫') {
                            marker.classList.add('filled');
                            marker.textContent = '‚ò∫';
                            marker.setAttribute('aria-label', 'Appointment: Notice given');
                        } else if (appt === 'P') {
                            marker.classList.add('priority');
                            marker.textContent = 'P';
                            marker.setAttribute('aria-label', 'Appointment: Priority');
                        } else if (appt === 'C') {
                            marker.classList.add('cancelled');
                            marker.textContent = 'C';
                            marker.setAttribute('aria-label', 'Appointment: Cancelled');
                        } else {
                            marker.setAttribute('aria-label', 'Empty appointment slot');
                        }
                        
                        marker.onclick = () => openModal(tech, day.id, index);
                        marker.onkeydown = (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                openModal(tech, day.id, index);
                            }
                        };
                        
                        dayCell.appendChild(marker);
                    });
                    
                    // Add "+" button to add new jobs
                    const addBtn = document.createElement('div');
                    addBtn.className = 'add-job-btn';
                    addBtn.textContent = '+';
                    addBtn.setAttribute('role', 'button');
                    addBtn.setAttribute('tabindex', '0');
                    addBtn.setAttribute('aria-label', `Add job for ${tech} on ${day.label}`);
                    addBtn.onclick = () => openAddJobModal(tech, day.id);
                    addBtn.onkeydown = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            openAddJobModal(tech, day.id);
                        }
                    };
                    dayCell.appendChild(addBtn);
                    
                    row.appendChild(dayCell);
                });
                
                const total = document.createElement('div');
                total.className = 'total-cell';
                
                const totalNum = document.createElement('div');
                totalNum.className = 'total-number';
                totalNum.textContent = calculateTechTotal(tech);
                total.appendChild(totalNum);
                
                let openSlots = 0;
                days.forEach(day => {
                    const dayAppts = data[tech][day.id] || [];
                    const emptyCount = dayAppts.filter(a => !a).length;
                    openSlots += emptyCount;
                });
                
                if (openSlots > 0) {
                    const availInfo = document.createElement('div');
                    availInfo.className = 'availability-info';
                    availInfo.textContent = `${openSlots} open slot${openSlots !== 1 ? 's' : ''}`;
                    total.appendChild(availInfo);
                }
                
                row.appendChild(total);
                techRows.appendChild(row);
            });
        }
        
        // Priority 3: Build structure once, update numbers only in updateTotals
        function renderDailyTotals() {
            const totalsRow = document.getElementById('dailyTotalsRow');
            
            // Only build structure if empty (prevents flicker/double-render)
            if (totalsRow.children.length === 0) {
                totalsRow.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
                
                const label = document.createElement('div');
                label.className = 'tech-name';
                label.textContent = 'Daily Totals';
                totalsRow.appendChild(label);
                
                days.forEach(day => {
                    const cell = document.createElement('div');
                    cell.className = 'total-cell';
                    cell.id = `total-${day.id}`;
                    
                    const totalNum = document.createElement('div');
                    totalNum.className = 'total-number';
                    totalNum.textContent = '0';
                    cell.appendChild(totalNum);
                    
                    const progress = document.createElement('div');
                    progress.className = 'goal-progress';
                    progress.id = `progress-${day.id}`;
                    progress.textContent = `0/${day.goal}`;
                    cell.appendChild(progress);
                    
                    totalsRow.appendChild(cell);
                });
                
                const grandTotal = document.createElement('div');
                grandTotal.className = 'total-cell';
                grandTotal.id = 'grand-total';
                
                const grandNum = document.createElement('div');
                grandNum.className = 'total-number';
                grandNum.textContent = '0';
                grandTotal.appendChild(grandNum);
                
                const grandProgress = document.createElement('div');
                grandProgress.className = 'goal-progress';
                grandProgress.id = 'grand-progress';
                grandProgress.textContent = '0/27';
                grandTotal.appendChild(grandProgress);
                
                totalsRow.appendChild(grandTotal);
            }
        }
        
        function renderCancellationRow() {
            const cancelRow = document.getElementById('cancellationRow');
            cancelRow.innerHTML = '';
            cancelRow.style.gridTemplateColumns = `150px repeat(${days.length}, 1fr) 150px`;
            
            const label = document.createElement('div');
            label.className = 'tech-name';
            label.textContent = 'Cancellation Factor';
            cancelRow.appendChild(label);
            
            let totalCancelled = 0;
            let totalAll = 0;
            
            days.forEach(day => {
                let dayCancelled = 0;
                let dayTotal = 0;
                
                techs.forEach(tech => {
                    const appts = data[tech][day.id] || [];
                    dayCancelled += appts.filter(a => a === 'C').length;
                    dayTotal += appts.filter(a => a).length;
                });
                
                totalCancelled += dayCancelled;
                totalAll += dayTotal;
                
                const cell = document.createElement('div');
                cell.className = 'cancel-cell';
                
                const percentage = dayTotal > 0 ? ((dayCancelled / dayTotal) * 100).toFixed(1) : '0.0';
                cell.textContent = `${dayCancelled}/${dayTotal} (${percentage}%)`;
                cancelRow.appendChild(cell);
            });
            
            const totalCell = document.createElement('div');
            totalCell.className = 'cancel-cell';
            const totalPercentage = totalAll > 0 ? ((totalCancelled / totalAll) * 100).toFixed(1) : '0.0';
            totalCell.textContent = `${totalCancelled}/${totalAll} (${totalPercentage}%)`;
            cancelRow.appendChild(totalCell);
        }
        
        function renderNotes() {
            const notesGrid = document.getElementById('notesGrid');
            notesGrid.innerHTML = '';
            
            const placeholders = [
                "Example: Customer callbacks, special instructions, part delays, gate codes...\n‚Ä¢ Mrs. Johnson needs follow-up in 2 weeks\n‚Ä¢ Oak St property - gate code 1234\n‚Ä¢ Heavy traffic on Route 9 - add 15min buffer",
                "Example: Rescheduling needs, tech availability, priority jobs...\n‚Ä¢ Call Mr. Wilson to reschedule Thursday slot\n‚Ä¢ Tech 3 has training 2-4pm, reassign calls\n‚Ä¢ Emergency job for Smith - moved to priority",
                "Example: Parts orders, callbacks, weather alerts, team notes...\n‚Ä¢ Parts delayed for Anderson job - reschedule Friday\n‚Ä¢ Rain expected afternoon - waterproof equipment\n‚Ä¢ Team meeting 3pm - schedule around it"
            ];
            
            days.forEach((day, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';
                
                const noteLabel = document.createElement('div');
                noteLabel.className = 'note-label';
                noteLabel.textContent = `${day.label} ${day.date}`;
                
                const noteInput = document.createElement('textarea');
                noteInput.className = 'note-input';
                noteInput.id = `note-${day.id}`;
                noteInput.placeholder = placeholders[index] || placeholders[0];
                noteInput.value = day.notes || '';
                noteInput.setAttribute('aria-label', `Notes for ${day.label} ${day.date}`);
                noteInput.oninput = (e) => {
                    days[index].notes = e.target.value;
                };
                
                noteItem.appendChild(noteLabel);
                noteItem.appendChild(noteInput);
                notesGrid.appendChild(noteItem);
            });
        }
        
        function calculateTechTotal(tech) {
            let total = 0;
            days.forEach(day => {
                const appts = data[tech][day.id] || [];
                total += appts.filter(a => a && a !== 'C').length;
            });
            return total;
        }
        
        function updateTotals() {
            let overallGoal = 0;
            
            days.forEach(day => {
                let dayTotal = 0;
                techs.forEach(tech => {
                    const dayAppts = data[tech][day.id] || [];
                    const count = dayAppts.filter(a => a && a !== 'C').length;
                    dayTotal += count;
                });
                
                const totalElem = document.getElementById(`total-${day.id}`);
                if (totalElem) {
                    const numElem = totalElem.querySelector('.total-number');
                    if (numElem) numElem.textContent = dayTotal;
                }
                
                const progressElem = document.getElementById(`progress-${day.id}`);
                if (progressElem) {
                    const goal = day.goal;
                    const percentage = goal > 0 ? (dayTotal / goal) * 100 : 0;
                    
                    progressElem.textContent = `${dayTotal}/${goal}`;
                    progressElem.classList.remove('met', 'close', 'behind');
                    
                    if (dayTotal >= goal) {
                        progressElem.classList.add('met');
                    } else if (percentage >= 75) {
                        progressElem.classList.add('close');
                    } else {
                        progressElem.classList.add('behind');
                    }
                }
                
                overallGoal += day.goal;
            });
            
            let grandTotal = 0;
            techs.forEach(tech => {
                grandTotal += calculateTechTotal(tech);
            });
            
            const grandTotalElem = document.getElementById('grand-total');
            if (grandTotalElem) {
                const numElem = grandTotalElem.querySelector('.total-number');
                if (numElem) numElem.textContent = grandTotal;
                
                const progressElem = document.getElementById('grand-progress');
                if (progressElem) {
                    const percentage = overallGoal > 0 ? (grandTotal / overallGoal) * 100 : 0;
                    progressElem.textContent = `${grandTotal}/${overallGoal}`;
                    
                    progressElem.classList.remove('met', 'close', 'behind');
                    if (grandTotal >= overallGoal) {
                        progressElem.classList.add('met');
                    } else if (percentage >= 75) {
                        progressElem.classList.add('close');
                    } else {
                        progressElem.classList.add('behind');
                    }
                }
            }
        }
        
        function renderBoard() {
            renderGoalsBar();
            renderHeader();
            renderTechRows();
            renderDailyTotals(); // Builds structure once
            renderCancellationRow();
            renderNotes();
            updateTotals(); // Updates numbers only
            
            // Save current date data whenever board is re-rendered
            saveCurrentDateData();
        }
        
        // Auto-save to browser localStorage
        function saveToLocal() {
            // Save current visible data before storing
            saveCurrentDateData();
            
            const boardData = {
                version: '1.0',
                savedAt: new Date().toISOString(),
                techs: techs,
                days: days,
                data: data,
                customRows: customRows,
                dateStorage: dateStorage // Save all date memories
            };
            localStorage.setItem('callBoardData', JSON.stringify(boardData));
        }
        
        function loadFromLocal() {
            const saved = localStorage.getItem('callBoardData');
            if (!saved) return;
            
            try {
                const boardData = JSON.parse(saved);
                
                if (boardData.techs) {
                    techs.length = 0;
                    techs.push(...boardData.techs);
                }
                if (boardData.days) {
                    days.length = 0;
                    days.push(...boardData.days);
                }
                if (boardData.data) {
                    Object.keys(data).forEach(key => delete data[key]);
                    Object.assign(data, boardData.data);
                }
                if (boardData.customRows) {
                    customRows.length = 0;
                    customRows.push(...boardData.customRows);
                }
                if (boardData.dateStorage) {
                    dateStorage = boardData.dateStorage;
                    // Load data for current dates
                    loadDateData();
                }
                
                renderBoard();
            } catch (error) {
                // Silent fail for localStorage - not critical
            }
        }
        
        // Auto-save every 10 seconds
        setInterval(() => {
            saveToLocal();
        }, 10000);
        
        // Save on page unload
        window.addEventListener('beforeunload', () => {
            saveToLocal();
        });
        
        // Initialize app
        window.addEventListener('load', () => {
            loadFromLocal();
            initializeDatePicker(); // Auto-applies today's date
        });
    </script>
</body>
</html>
